<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="https://deku.posstree.com/feed.xml" rel="self" type="application/atom+xml"/><link href="https://deku.posstree.com/" rel="alternate" type="text/html"/><updated>2025-07-03T17:48:26+09:00</updated><id>https://deku.posstree.com/feed.xml</id><title type="html">Deku</title><subtitle>『Programming Artist, DeKu』</subtitle><author><name>dev.yakuza@gmail.com</name></author><entry xml:lang="ja"><title type="html">[Flutter] アプリのアクセシビリティ(Accessibility)</title><link href="https://deku.posstree.com/flutter/accessibility/" rel="alternate" type="text/html" title="[Flutter] アプリのアクセシビリティ(Accessibility)"/><published>2025-01-03T00:00:00+09:00</published><updated>2025-01-22T21:14:48+09:00</updated><id>https://deku.posstree.com/flutter/accessibility-ja</id><content type="html" xml:base="https://deku.posstree.com/flutter/accessibility/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#google-play-console%E3%81%A7%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E6%A4%9C%E6%9F%BB">Google Play Consoleでアクセシビリティ検査</a></li><li><a href="#%E3%82%A6%E3%82%A3%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E5%90%91%E4%B8%8A">ウィジェットのアクセシビリティ向上</a><ul><li><a href="#iconbutton%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3">IconButtonのアクセシビリティ</a></li><li><a href="#textfield%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3">TextFieldのアクセシビリティ</a></li><li><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E5%90%91%E4%B8%8A%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEsemantics%E3%82%A6%E3%82%A3%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88">アクセシビリティ向上のためのSemanticsウィジェット</a></li><li><a href="#%E8%89%B2%E3%81%AE%E5%AF%BE%E6%AF%94%E3%81%A8%E3%83%9C%E3%82%BF%E3%83%B3%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA">色の対比とボタンのサイズ</a></li></ul></li><li><a href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E3%83%86%E3%82%B9%E3%83%88">アクセシビリティテスト</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>Flutterでアプリのアクセシビリティ(Accessibility)を検査して向上させる方法を提供しています。</p><ul><li><a href="https://docs.flutter.dev/ui/accessibility-and-internationalization/accessibility" rel="nofollow noreferrer">https://docs.flutter.dev/ui/accessibility-and-internationalization/accessibility</a></li></ul><p>今回のブログポストではFlutterで開発したアプリのアクセシビリティを向上させる方法を説明します。</p><h2 id="google-play-consoleでアクセシビリティ検査">Google Play Consoleでアクセシビリティ検査</h2><p>Google Play Consoleに移動して、<code class="language-plaintext highlighter-rouge">テスト(Testing) &gt; リリース前レポート(Pre-launch report) &gt; 詳細(Details) &gt; ユーザー補助機能(Accessibility)</code>から、アプリのアクセシビリティを検査して結果を確認できます。</p><picture><source srcset="/assets/images/category/flutter/2025/accessibility/accessibility_check.avif" type="image/avif"/><source srcset="/assets/images/category/flutter/2025/accessibility/accessibility_check.webp" type="image/webp"/><img src="/assets/images/category/flutter/2025/accessibility/accessibility_check.png" alt="Flutter - Accessibility check on Google Play Console"/></picture><p>アプリをリリースする前に、公開/非公開/内部テストを行った場合、このセクションでアクセシビリティの結果を確認できます。特に問題が見つからなければ、アプリのアクセシビリティが良好であると見なすことができます。</p><p>このセクションで問題が見つかった場合は、今回のブログポストで紹介した内容を参考にしてアプリのアクセシビリティを向上させることができます。</p><h2 id="ウィジェットのアクセシビリティ向上">ウィジェットのアクセシビリティ向上</h2><p>特定のウィジェットはアクセシビリティ向上のために追加のプロパティを提供します。アクセシビリティ向上のためのプロパティがないウィジェットでも、<code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットを使ってアクセシビリティを向上させることができます。</p><h3 id="iconbuttonのアクセシビリティ">IconButtonのアクセシビリティ</h3><p><code class="language-plaintext highlighter-rouge">IconButton</code>ウィジェットを使うと、<code class="language-plaintext highlighter-rouge">Screen Reader</code>がそのウィジェットを認識できないことがあります。この場合は、<code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットを使って<code class="language-plaintext highlighter-rouge">IconButton</code>ウィジェットをラップするか、<code class="language-plaintext highlighter-rouge">IconButton</code>ウィジェットの<code class="language-plaintext highlighter-rouge">Tooltip</code>プロパティを使用してアクセシビリティを向上させることができます。</p><ul><li><code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットを使った例</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Semantics</span><span class="p">(</span>
  <span class="nl">button:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nl">label:</span> <span class="s">'Add'</span><span class="p">,</span>
  <span class="nl">child:</span> <span class="n">IconButton</span><span class="p">(</span>
    <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="o">.</span><span class="na">add</span><span class="p">),</span>
    <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{},</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">Tooltip</code>プロパティを使った例</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IconButton</span><span class="p">(</span>
  <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="o">.</span><span class="na">add</span><span class="p">),</span>
  <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{},</span>
  <span class="nl">tooltip:</span> <span class="s">'Add'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="textfieldのアクセシビリティ">TextFieldのアクセシビリティ</h3><p><code class="language-plaintext highlighter-rouge">TextField</code>ウィジェットを使う時、<code class="language-plaintext highlighter-rouge">labelText</code>プロパティや<code class="language-plaintext highlighter-rouge">hintText</code>プロパティを使ってアクセシビリティを向上させることができます。</p><ul><li><code class="language-plaintext highlighter-rouge">labelText</code>プロパティを使った例</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TextField</span><span class="p">(</span>
  <span class="nl">decoration:</span> <span class="n">InputDecoration</span><span class="p">(</span>
    <span class="nl">labelText:</span> <span class="s">'Email'</span><span class="p">,</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">hintText</code>プロパティを使った例</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TextField</span><span class="p">(</span>
  <span class="nl">decoration:</span> <span class="n">InputDecoration</span><span class="p">(</span>
    <span class="nl">hintText:</span> <span class="s">'Email'</span><span class="p">,</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h3 id="アクセシビリティ向上のためのsemanticsウィジェット">アクセシビリティ向上のためのSemanticsウィジェット</h3><p><code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットを使ってアクセシビリティを向上させることができます。例えば、<code class="language-plaintext highlighter-rouge">Switch</code>ウィジェットを使う時、<code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットで<code class="language-plaintext highlighter-rouge">Switch</code>ウィジェットをラップして、<code class="language-plaintext highlighter-rouge">label</code>プロパティを使ってアクセシビリティを向上させることができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Semantics</span><span class="p">(</span>
  <span class="nl">label:</span> <span class="s">'Enable push notifications'</span><span class="p">,</span>
  <span class="nl">child:</span> <span class="n">Switch</span><span class="p">(</span>
    <span class="nl">value:</span> <span class="n">_value</span><span class="p">,</span>
    <span class="nl">onChanged:</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
        <span class="n">_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div><p>また、<code class="language-plaintext highlighter-rouge">InkWell</code>ウィジェットを使う時も、<code class="language-plaintext highlighter-rouge">Semantics</code>ウィジェットを使ってアクセシビリティを向上させることができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Semantics</span><span class="p">(</span>
  <span class="nl">label:</span> <span class="s">'Open profile'</span><span class="p">,</span>
  <span class="nl">child:</span> <span class="n">InkWell</span><span class="p">(</span>
    <span class="nl">onTap:</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Open profile</span>
    <span class="p">},</span>
    <span class="nl">child:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="o">.</span><span class="na">person</span><span class="p">),</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="色の対比とボタンのサイズ">色の対比とボタンのサイズ</h3><p>アクセシビリティを向上させるために、色の対比やボタンのサイズを調整する必要があります。この部分では適切な色の対比とボタンのサイズを使ってアクセシビリティを向上させることができます。</p><p>適切な色の対比とサイズを確認するために、<code class="language-plaintext highlighter-rouge">Flutter</code>が提供するアクセシビリティテストを使うことができます。</p><h2 id="アクセシビリティテスト">アクセシビリティテスト</h2><p><code class="language-plaintext highlighter-rouge">Flutter</code>でアクセシビリティを向上させるために、アクセシビリティテストを行うことができます。アクセシビリティテストを行うことで、アプリのアクセシビリティが向上しているかどうかを確認することができます。</p><p><code class="language-plaintext highlighter-rouge">Flutter</code>のウィジェットテストコードで次のようにアクセシビリティテストを追加することができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testWidgets</span><span class="p">(</span><span class="s">'Check accessibility'</span><span class="p">,</span> <span class="p">(</span><span class="n">WidgetTester</span> <span class="n">tester</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">SemanticsHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="na">ensureSemantics</span><span class="p">();</span>

  <span class="k">await</span> <span class="n">tester</span><span class="o">.</span><span class="na">pumpWidget</span><span class="p">(</span><span class="n">TargetWidget</span><span class="p">());</span>

  <span class="k">await</span> <span class="n">expectLater</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">meetsGuideline</span><span class="p">(</span><span class="n">androidTapTargetGuideline</span><span class="p">));</span>
  <span class="k">await</span> <span class="n">expectLater</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">meetsGuideline</span><span class="p">(</span><span class="n">iOSTapTargetGuideline</span><span class="p">));</span>
  <span class="k">await</span> <span class="n">expectLater</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">meetsGuideline</span><span class="p">(</span><span class="n">labeledTapTargetGuideline</span><span class="p">));</span>
  <span class="k">await</span> <span class="n">expectLater</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">meetsGuideline</span><span class="p">(</span><span class="n">textContrastGuideline</span><span class="p">));</span>
  <span class="n">handle</span><span class="o">.</span><span class="na">dispose</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div><p>このテストコードを使って、色の対比やボタンのサイズ、スクリーンリーダーが認識できるラベルなどを確認することができます。</p><h2 id="完了">完了</h2><p>これで、<code class="language-plaintext highlighter-rouge">Flutter</code>で開発したアプリのアクセシビリティを向上させる方法について説明しました。また、<code class="language-plaintext highlighter-rouge">Flutter</code>が提供するアクセシビリティテストを使ってアクセシビリティを向上させる方法についても説明しました。</p><p>みなさんも<code class="language-plaintext highlighter-rouge">Flutter</code>で開発したアプリのアクセシビリティを向上させるために、テストコードを書いてアクセシビリティを向上させる方法を適用してみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="flutter"/><summary type="html"><![CDATA[Flutterで開発したアプリのアクセシビリティ(Accessibility)を向上させる方法について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/flutter/background.png"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/flutter/background.png" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[Code Quality] Semgrepを使って正規表現でコードを検査する</title><link href="https://deku.posstree.com/code_quality/semgrep/" rel="alternate" type="text/html" title="[Code Quality] Semgrepを使って正規表現でコードを検査する"/><published>2024-12-18T00:00:00+09:00</published><updated>2025-01-11T12:45:15+09:00</updated><id>https://deku.posstree.com/code_quality/semgrep-ja</id><content type="html" xml:base="https://deku.posstree.com/code_quality/semgrep/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#semgrep">Semgrep</a></li><li><a href="#semgrep%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">Semgrepのインストール</a></li><li><a href="#semgrep%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A">Semgrepルールの設定</a></li><li><a href="#semgrep%E3%81%AE%E5%AE%9F%E8%A1%8C">Semgrepの実行</a></li><li><a href="#github-actions">GitHub Actions</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>開発をする時、コードの品質を高めるためにLintなどの静的解析ツールを使います。しかし、静的解析ツールは一般的なルールしか提供せず、すべてのルールを提供しません。そのため、静的解析ツールが提供していないルールをコード検査に追加したい場合は、Lintのカスタムルールを追加して使ったりします。</p><ul><li><a href="https://eslint.org/docs/latest/extend/custom-rules" rel="nofollow noreferrer" target="_blank">ESLint Custom Rules</a></li></ul><p>このように追加したカスタムルールはLintの対象となるコードだけ検査が可能ですが、コメントなどの部分は検査を行えない場合があります。このような場合、<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って正規表現を使ってカスタムルールを作成することができます。</p><h2 id="semgrep">Semgrep</h2><p><code class="language-plaintext highlighter-rouge">Semgrep</code>はコードの安全性、品質、スタイルを自動で検査して改善するための静的解析ツールです。主にソースコードを解析してセキュリティ脆弱性、バグ、コード品質の問題を見つけるのに使われます。</p><ul><li>Semgrep: <a href="https://github.com/semgrep/semgrep" rel="nofollow noreferrer" target="_blank">https://github.com/semgrep/semgrep</a></li></ul><p><code class="language-plaintext highlighter-rouge">Semgrep</code>はユーザー定義ルールを正規表現パターンで書くことができます。これを使うとLintなどの静的解析ツールでは検査が難しい部分を検査することができます。</p><ul><li><a href="https://semgrep.dev/docs/writing-rules/rule-ideas" rel="nofollow noreferrer" target="_blank">https://semgrep.dev/docs/writing-rules/rule-ideas</a></li></ul><p>今回のブログポストでは、<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って正規表現でコードを検査する方法について説明します。</p><h2 id="semgrepのインストール">Semgrepのインストール</h2><p><code class="language-plaintext highlighter-rouge">Semgrep</code>はPythonで動作するため、基本的にPythonがインストールされている必要があります。各OSにPythonをインストールする方法は省略します。</p><p><code class="language-plaintext highlighter-rouge">Semgrep</code>はPythonパッケージとしてインストールすることができます。<code class="language-plaintext highlighter-rouge">Semgrep</code>をインストールするために次のコマンドを実行します。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>semgrep
</code></pre></div></div><p>インストールしたら、他の場所でも使えるように<code class="language-plaintext highlighter-rouge">requirements.txt</code>を作成します。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip freeze <span class="o">&gt;</span> requirements.txt
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code>を開くと、次のような内容が追加されていることを確認できます。</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">semgrep==</span><span class="mf">1.97</span><span class="err">.</span><span class="mi">0</span><span class="w">
</span></code></pre></div></div><p>この<code class="language-plaintext highlighter-rouge">requirements.txt</code>を使って、他の場所で<code class="language-plaintext highlighter-rouge">Semgrep</code>をインストールするためには次のコマンドを使います。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="semgrepルールの設定">Semgrepルールの設定</h2><p>次は、<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って正規表現でコードを検査するためのコードルールを作成してみます。まず、<code class="language-plaintext highlighter-rouge">code-rules.yaml</code>ファイルを作成し、次の内容を書きます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">missing-param-description</span>
    <span class="na">severity</span><span class="pi">:</span> <span class="s">ERROR</span>
    <span class="na">message</span><span class="pi">:</span> <span class="s">【Comment error】 Add correct comment.</span>
    <span class="na">languages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">javascript</span>
      <span class="pi">-</span> <span class="s">typescript</span>
    <span class="na">patterns</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pattern-regex</span><span class="pi">:</span> <span class="s">\*\s*@.*-\s*(\n|\r\n|$)</span>
</code></pre></div></div><p>このルールは次のような内容を検査します。</p><p>❌ Incorrect</p><p>次のようにコメントを書いていないまま<code class="language-plaintext highlighter-rouge">-</code>を残している場合、エラーが発生します。</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cm">/**
   * Add two numbers
   * @param {number} a - number for addition
   * @param {number} b -
   * @returns {number}
   */</span>
</code></pre></div></div><p>✅ Correct</p><p>次のようにすべてのコメントが書かれている場合、エラーは発生しません。</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cm">/**
   * Add two numbers
   * @param {number} a - number for addition
   * @param {number} b - number for addition
   * @returns {number}
   */</span>
</code></pre></div></div><h2 id="semgrepの実行">Semgrepの実行</h2><p>次は<code class="language-plaintext highlighter-rouge">Semgrep</code>を使ってコードを検査してみましょう。次のコマンドを実行すると、<code class="language-plaintext highlighter-rouge">Semgrep</code>がコードを検査して結果を出力します。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>semgrep <span class="nt">--config</span><span class="o">=</span>code-rules.yaml <span class="nt">--error</span>
</code></pre></div></div><p>このコマンドを実行すると、次のような結果が確認できます。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
┌──── ○○○ ────┐
│ Semgrep CLI │
└─────────────┘


Scanning 7035 files <span class="o">(</span>only git-tracked<span class="o">)</span> with 1 Code rule:

  CODE RULES
  Scanning 5089 files.

  SUPPLY CHAIN RULES

  No rules to run.


  PROGRESS

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00


┌──────────────────┐
│ 93 Code Findings │
└──────────────────┘

    apps/sample/view/index.ts
   ❯❯❱ missing-param-description
          【Comment error】 Add correct comment.

           12┆ <span class="k">*</span> @param <span class="o">{</span>Params<span class="o">}</span> params -
           13┆ <span class="k">*</span> @return <span class="o">{</span>number<span class="o">}</span>
...
</code></pre></div></div><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="github-actions">GitHub Actions</h2><p>このように設定した<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って、GitHub Actionsでコードを検査することができます。<code class="language-plaintext highlighter-rouge">.github/workflows/semgrep.yml</code>ファイルを作成し、次の内容を書きます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Check code by Semgrep</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">semgrep</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Check code by Semgrep</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v5</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">python-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.13'</span>
          <span class="na">cache</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pip'</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">pip install -r requirements.txt</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Semgrep</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">semgrep --config=code-rules.yaml --error</span>
</code></pre></div></div><p>これでGitHub ActionsでPRを作成すると、次のようなエラーが発生することが確認できます。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Run semgrep <span class="nt">--config</span><span class="o">=</span>code-rules.yaml <span class="nt">--error</span>
METRICS: Using configs from the Registry <span class="o">(</span>like <span class="nt">--config</span><span class="o">=</span>p/ci<span class="o">)</span> reports pseudonymous rule metrics to semgrep.dev.
To disable Registry rule metrics, use <span class="s2">"--metrics=off"</span><span class="nb">.</span>
Using configs only from <span class="nb">local </span>files <span class="o">(</span>like <span class="nt">--config</span><span class="o">=</span>xyz.yml<span class="o">)</span> does not <span class="nb">enable </span>metrics.

More information: https://semgrep.dev/docs/metrics



┌─────────────┐
│ Scan Status │
└─────────────┘
  Scanning 7034 files tracked by git with 1 Code rule:
  Scanning 5087 files.


┌──────────────────┐
│ 93 Code Findings │
└──────────────────┘

    apps/agencyTool/src/feature/AdminStaffDetailDialog/controller/actions/initialize/index.ts
   ❯❯❱ missing-param-description
          【Comment error】 Add correct comment.

           12┆ <span class="k">*</span> @param <span class="o">{</span>Params<span class="o">}</span> params -
           13┆ <span class="k">*</span> @return <span class="o">{</span>number<span class="o">}</span>
...
</code></pre></div></div><h2 id="完了">完了</h2><p>以上で、<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って正規表現でコードを検査する方法について説明しました。<code class="language-plaintext highlighter-rouge">Semgrep</code>を使うと、Lintなどの静的解析ツールでは検査が難しい部分を検査することができます。</p><p>コードレビューで同じ問題が繰り返し指摘されている場合は、まずESLintなどの静的解析ツールにその問題に関するルールがあるかどうかを調べ、ある場合はそのルールを追加します。</p><p>もし、そのルールがなく、その問題が定型化されたパターンを持っている場合は、<code class="language-plaintext highlighter-rouge">Semgrep</code>を使って正規表現でコードを検査する方法を試してみてください。</p><p>このブログポストが<code class="language-plaintext highlighter-rouge">Semgrep</code>を使ってコードの品質を向上させるのに役立てば幸いです。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="code_quality"/><summary type="html"><![CDATA[Semgrepを使って正規表現でコードを検査してコードの’品質を向上させる方法について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/code_quality/semgrep/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/code_quality/semgrep/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">社会資本と専門家</title><link href="https://deku.posstree.com/essay/social-capital-and-experts/" rel="alternate" type="text/html" title="社会資本と専門家"/><published>2024-12-05T00:00:00+09:00</published><updated>2025-01-23T21:08:22+09:00</updated><id>https://deku.posstree.com/essay/social-capital-and-experts-ja</id><content type="html" xml:base="https://deku.posstree.com/essay/social-capital-and-experts/"><![CDATA[<p>一つの技術や方法論だけで専門家になるのは難しい時代になりました。なので、専門家になるためには新しい技術と方法論などを実践し、良い点と悪い点を経験しながら成長しなければなりません。</p><p>新しい技術や方法論を学び、成長するためには、会社で新しい技術や方法論を使ってみるのが一番です。しかし、新しい技術を会社で導入しようとしてもチームメンバーと一緒に実践することは失敗する場合が多いです。大体の理由は自分が提案した新しい技術が問題があるからではありません。</p><p>チームで新しい何かを導入する時、私たちは技術的な側面だけを見て社会的な側面を考慮しません。チームメンバーが私を好きでなく、私もチームメンバーが気に入らない状態でどんなに良い技術を提案しても受け入れられません。</p><p>たとえ新しい技術や方法論を自分だけが使おうとしても、上司がそれを見て反対するなら、上司を説得しなければなりません。一人で実践しても分からないことがあれば周りに聞いて学ぶ必要がありますが、他のチームメンバーが実践していないため聞くこともできません。そのため社会的な側面を考慮しない新しい技術の習得ではスキルを向上させることはできません。</p><p>このように新しい技術を導入する時、その技術の利点や欠点だけでなく、社会的資本と社会的技術も考慮しなければなりません。</p><p>社会的資本は社会的関係を通じて得る資源であり、信頼、社会的ネットワーク、相互作用、社会的技術などがあります。社会的資本が高いと社会的関係を通じてより多くの資源を得ることができます。つまり、社会的資本が高いと新しい技術を導入することも新しい技術を習得することも簡単になります。</p><p>社会的技術は社会的状況で効果的に行動する能力を指します。社会的技術には挨拶、尋ねるなどのマイクロインタラクションから助けを求める、フィードバックを受け取る、影響力を持つ、教える、学ぶ、委任するなどがあります。</p><p>社会的技術と社会的資本を最大限活用して新しい技術導入を試みるべきで、自分が提案した新しい技術が受け入れやすくなります。こうして自分が提案した技術が受け入れられると、尋ねることができ、助けを受けることができて自分の技術力も伸びることになります。</p><p>応用統計学者出身のジョン・ゴットマンが書いた信頼の科学 (<a href="https://openlibrary.org/books/OL25004197M/The_science_of_trust" rel="nofollow noreferrer">The Science of Trust (John Mordecai Gottman. 2011. The Science of Trust: Emotional Attunement for Couples. W. W. Norton &amp; Company.)</a>)という本には、次のような研究結果があります。</p><blockquote><p>信頼が崩れている共働き夫婦がいました。ある日、夫が早く帰宅しました。シンクに皿が積まれているのを見て、夫はなぜか皿洗いをします。ここまでを隠しカメラで撮影して第三者に見せると、ほとんどの場合、夫が善意の行動をしたと評価します。反転は奥さんが家に帰ってきてからです。奥さんは夫に怒ります。”家事をちゃんとしないと抗議するのか”、”私にちょっとこうしろという意味なのか”などなど。</p></blockquote><p>ジョン・ゴットマンは本でこの状況を信頼が崩れている状態ではどんな行動をしても悪意的に見えると説明しています。</p><p>私たちの周辺でもこのような状況をよく見かける。チームのマネージャーとチームメンバーが信頼が崩れた状態でマネージャーが善意でチームメンバーに本をプレゼントする。するとチームメンバーはマネージャーの行動を悪意的に感じて、”私がこの部分が足りないから勉強しろというのか？自分もよく知らないのに…“と考えることができる。</p><p>信頼も社会的ネットワークも社会的資本の一種です。社会的資本は社会的技術を基盤としているため、社会的資本が高い人々は通常社会的技術が優れている。ここで紹介した例のように社会的資本がない状況では善意の提案(技術提案)をしても悪意的に受け入れられるため、善意の提案は受け入れられない。</p><p>そして専門家はドメイン知識が優れているだけでなく、社会的資本と社会的技術も優れています。ベル研究所で’優れた研究者’の特性についての研究を実行しましたが、優れた研究者は同じ頼みをしてもはるかに短い時間で他の人から助けを受けたと言います。つまり、専門家はドメイン知識が優れているだけでなく、社会的資本の一つである社会的コネクションも優れているということです。</p><p>ソフトウェアエンジニアリングで行われた研究も似た結果を出しました。優れたソフトウェア開発者ほど他者とインタラクションに多くの時間を費やし、初心者開発者に技術的なアドバイスだけでなく社会的側面が含まれたアドバイスをすることがわかりました。</p><ul><li><a href="https://www.cambridge.org/core/books/abs/cambridge-handbook-of-expertise-and-expert-performance/expertise-in-software-design/04E88E182D83E956AB5582CA846AFF73" rel="nofollow noreferrer" target="_blank">Thomas R. Riedl, Julian S. Weitzenfeld, Jared T. Freeman, Gary A. Klein, &amp; John Musa. (1991). What we have learned about software engineering expertise. In SEI conference on Software Engineering Education (pp. 1-12). Pittsburgh, PA: Software Engineering Institute.</a></li><li><a href="https://www.deepdyve.com/lp/american-psychological-association/interaction-of-social-skill-and-general-mental-ability-on-job-9c0mAvua8k" rel="nofollow noreferrer" target="_blank">Gerald R. Ferris, L. A. Witt, &amp; Wayne A. Hochwater. (2001). Interaction of social skill and general mental ability on job performance and salary. Journal of Applied Psychology, 86(6), 1075-1082.</a></li></ul><p>優れた開発者は約70%が同僚との協力を言及する一方、実力がそれほどでもない開発者は20%もいない人々だけが同僚との協力を言及したと言います。</p><ul><li><a href="https://pubmed.ncbi.nlm.nih.gov/9806013/" rel="nofollow noreferrer" target="_blank">Sabine Sonnentag. (1995). Expertise in professional software design: A process study. Journal of Applied Psychology.</a></li></ul><p>そしたらなぜ私たちは専門家を話す時、社会的資本と社会的技術について話さないのでしょうか？これは専門性に対する誤った理解とそれを基に設計された教育システムのせいです。</p><blockquote><p>既存の専門性研究は通常研究費を下げ、変数を減らすためにも個人を部屋に入れて彼の独自の行動と選択を研究しました。このような研究から出た専門家、非専門家の違いで専門家イメージが形成され、教育プロセスもそこに基づいて編まれたものがまだ多いです。</p></blockquote><p>このような研究は専門家の社会的資本と技術は考慮せず、専門家一人だけに集中し、その人が持つ技術と知識だけを考慮しました。しかし最近の研究では専門家にとって社会的資本と技術が重要だと言っています。</p><blockquote><p>昔はソフトウェア開発専門性と社交性は別々に見なされて “プログラミングスキルは良いがコミュニケーション能力が不足している”などと話していましたが、今はプログラミングをうまくするという定義の中にコミュニケーション能力をその一部として見るようになりました。</p></blockquote><p>しかし、私たちは最近の研究を基にした教育を受けて成長していません。現在の教育システムも最近の研究を反映していません。そのため、私たちはまだ古い認識を変えず、専門家になるために社会的資本と社会的技術を無視して、ドメイン知識だけを学ぼうとしています。そして社会的資本と技術がない状態でドメイン知識だけを高めると、その知識の普及と成功にはむしろ障害になります。</p><p>幸いなことに社会的技術はトレーニングを通じて改善できます。最も簡単な方法は、毎日の挨拶、会話、質問などの日常的なマイクロインタラクションに注意を払うことです。マイクロインタラクションを記録し、振り返り、他のインタラクションにどのように適用するかを考えてみます。</p><p>このようなマイクロインタラクションを通じて社会的技術をトレーニングしたなら、次に助けを求める、フィードバックを受け取る、影響力を持つ、教える、学ぶ、委任するなどの一段上の社会的技術を行いながら社会的資本を積み上げていけば良いです。</p><p>新しい技術を導入する時、この質問をしてみましょう。”私のチームメンバーは私を好きですか？” この質問に “No” と答えるなら、新しい技術を導入するのは難しいでしょう。逆に “Yes” と答えるなら、新しい技術を導入するのは簡単でしょう。社会的技術を通じてチームメンバーと信頼を積み上げ、専門家になるために新しい技術や方法論だけに集中せず、社会的資本を積むことにも集中しましょう。そうすれば専門家になる道がより簡単になるでしょう。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="essay"/><summary type="html"><![CDATA[専門家になるためには会社で新しい技術や方法論を使ってみなければいけません。しかし、自分が提案した新しい技術は導入できないことが多いです。自分が提案した新しい技術が導入されない理由は何であるか、新しい技術をもっと簡単に導入するためにはどのような方法があるのか見てみましょう。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/essay/2024/social-capital-and-experts/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/essay/2024/social-capital-and-experts/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">効果的な従業員教育のための講師選定方法</title><link href="https://deku.posstree.com/essay/effective-employee-training/" rel="alternate" type="text/html" title="効果的な従業員教育のための講師選定方法"/><published>2024-11-14T00:00:00+09:00</published><updated>2024-12-03T20:54:19+09:00</updated><id>https://deku.posstree.com/essay/effective-employee-training-ja</id><content type="html" xml:base="https://deku.posstree.com/essay/effective-employee-training/"><![CDATA[<p>大体の企業は従業員教育に多額の費用を投資しています。従業員が成長すれば会社も成長できるためです。しかし、多くの企業は教育を通じて実質的な効果を得ていません。なぜ企業は教育に多額の費用を投資しているのに、実際には大きな効果を得ていないのでしょうか？</p><p>企業は教育を実施する際、従業員が成長し、その成長が会社に影響を与えることを期待しています。しかし、ほとんどの企業は、今年どのような教育を何人が修了したかを確認するだけで、教育の成果を測定していません。従業員が実質的にどれだけ助けを受け、どれだけ成長したかを測定していません。</p><p>企業での教育、トレーニングの効果に関するメタ分析研究によると、ほとんどの教育は6ヶ月ほど経つと効果がほとんど消えるとされています。教育を修了した時点では、従業員の満足度が高く、業務に非常に役立つと感じるかもしれませんが、実際には大きな効果がありません。</p><p>このような問題が発生する最大の理由は、教育を行う講師にあります。企業は講師を選定する際、主にどれだけ多くの知識を持っているかを考慮して選定します。</p><p>しかし、ジョン・ハッティの研究によると、講師の知識レベルの効果は0.09であり、学業成績に影響を与える150以上の要因の中で135位にとどまります。つまり、講師がどれだけ多くの専門知識を持っているかは、学習成果にほとんど影響を与えません。</p><blockquote><p>医療分野の研究によると、専門家が特定の手術法を学生に教える際、医学的知識、何をどのようにすべきかの行動段階、意思決定段階など、自分が該当課題を実行する際に使用する知識のうち<code class="language-plaintext highlighter-rouge">70%は教えない</code>という研究結果が多い。</p></blockquote><p>医学のような専門分野で専門家が学生に教える際、専門家が持っている知識の<code class="language-plaintext highlighter-rouge">70%は教えない</code>という研究結果が多いです。</p><p>一般的に優れた講師は、その分野について多くの知識を持っていると考えられます。しかし、教育は究極的には学生が<code class="language-plaintext highlighter-rouge">より良くなる</code>のを助けることが目的であるため、教育という文脈では、講師が持っている知識は大きな助けにはなりません。</p><p>知識が多いからといって必ずしも良い講師であるとは限らず、知識が多い人から学んだからといって学生の実力が向上するわけではありません。</p><blockquote><p>教える能力が認められ、一度以上の優れた教育賞を受賞した人であっても、できるだけ段階や知識を抜かりなく教えてくれる特定の呪文を受けたにもかかわらず、同じようでした。さらには授業が終わって「もし落としたものがありますか」と尋ねた後、それを追加しても依然として70%程度は落としました。</p></blockquote><p>専門家、卓越した教育賞を受けた人であっても、学生に該当技術を成功的にやり遂げるために必要なことの30%だけを教えておいて、自分はすべて教えたと思うということだ。</p><p>この問題を解決するためには、先生と学生が一緒に努力しなければならない。 先生の認知的分析に長けた程度が生徒たちの学業成就度に及ぼす影響は1.29だ。すなわち、この認知的分析能力が優れた先生がよく教えることだ。</p><p>先生は次のようにメタ認知を高める努力ができる。</p><blockquote><p>「私がこの問題を解決する時、どんな過程を経るのか」を考えて自身の頭の中を観察し、質問を投げかけて分析することだ。 そして学生たちがこれを学びながらどんな考えをしているのかを直接観察し質問を投げかけて分析することができる。</p></blockquote><p>学生はこのような認知的作業分析が上手な先生を選択することができる。 また、先生の認知的作業分析を助けるために、自分がどのようにこの問題を解いたのか、その認知的過程を先生に知らせることも非常に効果的な方法だ。 または、先生がその問題を解いた認知的過程を教えてほしいと要請することもできる。 認知的作業分析については、次の文を参考にすれば役に立つだろう。</p><ul><li><a href="https://deku.posstree.com/essay/cognitibe-task-analysis/" target="\_blank">認知的作業分析による専門家の専門性の引き出し</a></li></ul><p>他の人を教えたり学ぶ場でこのような部分を考えながら参加すれば、学習効果が増加することを確認できるだろう。 会社は単純に講師が知識を伝達する学習ではなく、講師と職員が一緒に認知的作業分析を通じて学習できる環境を作らなければならない。 そうでなければ、教育に投資した費用対比、大きな効果を得ることができないだろう。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="essay"/><summary type="html"><![CDATA[企業は従業員教育に多額の費用を投資していますが、実際には大きな効果を得ていません。なぜ企業は教育に多額の費用を投資しているのに、実際には大きな効果を得ていないのでしょうか？]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/essay/2024/effective-employee-training/background.webp"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/essay/2024/effective-employee-training/background.webp" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[GitHub Actions] Reviewerに通知するためのSlackメッセージを送信する</title><link href="https://deku.posstree.com/github_actions/send_slack_message_for_reviewer/" rel="alternate" type="text/html" title="[GitHub Actions] Reviewerに通知するためのSlackメッセージを送信する"/><published>2024-11-13T00:00:00+09:00</published><updated>2024-12-17T08:50:33+09:00</updated><id>https://deku.posstree.com/github_actions/send-slack-message-ja</id><content type="html" xml:base="https://deku.posstree.com/github_actions/send_slack_message_for_reviewer/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#slack%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E4%BD%9C%E6%88%90">Slackアプリの作成</a></li><li><a href="#%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%ABid">チャンネルID</a></li><li><a href="#slack-github-action%E3%82%92%E4%BD%BF%E3%81%86">slack-github-actionを使う</a></li><li><a href="#composite-action">Composite Action</a></li><li><a href="#reviewer%E9%80%9A%E7%9F%A5">Reviewer通知</a></li><li><a href="#%E6%AF%8E%E6%9C%9D%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E9%80%81%E4%BF%A1">毎朝メッセージ送信</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>GitHub Actionsを使ってCI/CDを構築すると、ビルド、テストが成功または失敗した時にSlackにメッセージを送りたい場合があります。今回のブログでは、GitHub Actionsを使ってSlackメッセージを送る方法について説明します。</p><h2 id="slackアプリの作成">Slackアプリの作成</h2><p>Slackは対話型メッセージングプラットフォームで、メッセージを受け取るという意味は誰かがメッセージを送ったことを意味します。そのため、GitHub Actionsを使ってSlackメッセージを送るためには、Slackメッセージを送るSlackアプリを作成する必要があります。</p><p>まず、次のリンクをクリックして<code class="language-plaintext highlighter-rouge">Slack API</code>にアクセスします。</p><ul><li><a href="https://api.slack.com/" rel="nofollow noreferrer" target="_blank">https://api.slack.com/</a></li></ul><p>すると次の画面が表示されます。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/slack_api.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/slack_api.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/slack_api.png" alt="GitHub Actions Send Slack message - Slack API site"/></picture><p>画面右上の<code class="language-plaintext highlighter-rouge">Your apps</code>を選択してアプリ作成画面に移動します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app.png" alt="GitHub Actions Send Slack message - Create new Slack app"/></picture><p><code class="language-plaintext highlighter-rouge">Create New App</code>を選択して新しいアプリを生成します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app_options.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app_options.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/create_new_app_options.png" alt="GitHub Actions Send Slack message - Create new Slack app options"/></picture><p>この時、<code class="language-plaintext highlighter-rouge">From scratch</code>を選択して新しいアプリを生成します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_name_and_workspace.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_name_and_workspace.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_name_and_workspace.png" alt="GitHub Actions Send Slack message - Enter app name and workspace"/></picture><p>その後、アプリの名前を入力して、コナぷりを使うSlackのWorkspaceを選択して<code class="language-plaintext highlighter-rouge">Create App</code>ボタンをクリックします。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_created.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_created.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/app_created.png" alt="GitHub Actions Send Slack message - App created"/></picture><p>すると上記のようにアプリが生成されることを確認できます。</p><p>次はこのアプリにメッセージを送る権限を設定する必要があります。アプリ一覧画面で新しく作成したアプリの名前を選択してアプリ詳細ページに移動します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions.png" alt="GitHub Actions Send Slack message - OAuth and Permissions"/></picture><p>その後、左メニューにある<code class="language-plaintext highlighter-rouge">OAuth &amp; Permissions</code>を選択して<code class="language-plaintext highlighter-rouge">OAuth &amp; Permissions</code>画面に移動します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_scopes.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_scopes.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_scopes.png" alt="GitHub Actions Send Slack message - OAuth and Permissions scopes"/></picture><p>少しスクロールして<code class="language-plaintext highlighter-rouge">Scopes</code>セクションに移動し、<code class="language-plaintext highlighter-rouge">Add an OAuth Scope</code>ボタンをクリックして<code class="language-plaintext highlighter-rouge">chat:write</code>権限を追加します。</p><p>最後に<code class="language-plaintext highlighter-rouge">OAuth Tokens</code>セクションに移動して、<code class="language-plaintext highlighter-rouge">Install to (workspace)</code>ボタンをクリックしてSlackアプリをインストールします。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_install_app.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_install_app.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_install_app.png" alt="GitHub Actions Send Slack message - OAuth and Permissions install app"/></picture><p>アプリをインストールすると、次のように<code class="language-plaintext highlighter-rouge">Bot User OAuth Access Token</code>が生成されることを確認できます。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_bot_user_oauth_access_token.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_bot_user_oauth_access_token.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/oauth_and_permissions_bot_user_oauth_access_token.png" alt="GitHub Actions Send Slack message - OAuth and Permissions Bot User OAuth Access Token"/></picture><p>次はこのように生成されたトークンを<code class="language-plaintext highlighter-rouge">GitHub Actions</code>で使用するために<code class="language-plaintext highlighter-rouge">GitHub</code>の<code class="language-plaintext highlighter-rouge">Secrets</code>に保存する必要があります。Slackメッセージを送りたい<code class="language-plaintext highlighter-rouge">GitHub</code>リポジトリに移動します。</p><p>その後、<code class="language-plaintext highlighter-rouge">Settings &gt; Secrets and variables &gt; Actions</code>メニューをクリックして<code class="language-plaintext highlighter-rouge">Actions secrets and variables</code>ページに移動します。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/github_secrets_and_variables.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/github_secrets_and_variables.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/github_secrets_and_variables.png" alt="GitHub Actions Send Slack message - GitHub secrets and variables"/></picture><p>画面に表示された<code class="language-plaintext highlighter-rouge">Repository secrets</code>の<code class="language-plaintext highlighter-rouge">New repository secret</code>ボタンをクリックして、<code class="language-plaintext highlighter-rouge">Name</code>に<code class="language-plaintext highlighter-rouge">SLACK_BOT_TOKEN</code>を入力し、<code class="language-plaintext highlighter-rouge">Value</code>に<code class="language-plaintext highlighter-rouge">Slack API</code>サイトで生成したトークンを入力して<code class="language-plaintext highlighter-rouge">Add secret</code>ボタンをクリックして保存します。</p><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="チャンネルid">チャンネルID</h2><p><code class="language-plaintext highlighter-rouge">GitHub Actions</code>を使ってSlackのチャンネルにメッセージを送るためには<code class="language-plaintext highlighter-rouge">CHANNEL_ID</code>が必要です。</p><p><code class="language-plaintext highlighter-rouge">CHANNEL_ID</code>は<code class="language-plaintext highlighter-rouge">Slack</code>で取得できます。個人に直接送りたい場合は、次のように個人プロフィールから<code class="language-plaintext highlighter-rouge">Copy member ID</code>をクリックして<code class="language-plaintext highlighter-rouge">CHANNEL_ID</code>を取得することができます。</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/copy_slack_member_channel_id.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/copy_slack_member_channel_id.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/copy_slack_member_channel_id.png" alt="GitHub Actions Send Slack message - Copy Slack member channel ID"/></picture><p>もし、特定のチャンネルにメッセージを送りたい場合は、<code class="language-plaintext highlighter-rouge">Open channel details</code>をクリックしてチャンネルの詳細情報に移動した後、</p><picture><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/open_slack_channel_details.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/send_slack_message_for_reviewer/open_slack_channel_details.webp" type="image/webp"/><img src="/assets/images/category/github_actions/send_slack_message_for_reviewer/open_slack_channel_details.png" alt="GitHub Actions Send Slack message - Copy Slack channel ID"/></picture><p>下に表示された<code class="language-plaintext highlighter-rouge">Channel ID</code>をコピーして使えば良いです。</p><h2 id="slack-github-actionを使う">slack-github-actionを使う</h2><p><code class="language-plaintext highlighter-rouge">Slack</code>から公式で提供されている<code class="language-plaintext highlighter-rouge">slack-github-action</code>を使うと<code class="language-plaintext highlighter-rouge">GitHub Actions</code>から<code class="language-plaintext highlighter-rouge">Slack</code>にメッセージを送ることができます。</p><ul><li>slack-github-action: <a href="https://github.com/slackapi/slack-github-action" rel="nofollow noreferrer" target="_blank">https://github.com/slackapi/slack-github-action</a></li></ul><p><code class="language-plaintext highlighter-rouge">GitHub Actions</code>を次のように<code class="language-plaintext highlighter-rouge">slack-github-action</code>を使うように修正すると<code class="language-plaintext highlighter-rouge">Slack</code>にメッセージを送ることができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Post to a Slack channel</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">slack</span>
  <span class="na">uses</span><span class="pi">:</span> <span class="s">slackapi/slack-github-action@v1.27.0</span>
  <span class="na">with</span><span class="pi">:</span>
    <span class="na">channel-id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">CHANNEL_ID'</span>
    <span class="na">payload</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">{</span>
        <span class="s">"text": "GitHub Action build result: ${{ job.status }}\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}",</span>
        <span class="s">"blocks": [</span>
          <span class="s">{</span>
            <span class="s">"type": "section",</span>
            <span class="s">"text": {</span>
              <span class="s">"type": "mrkdwn",</span>
              <span class="s">"text": "GitHub Action build result: ${{ job.status }}\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}"</span>
            <span class="s">}</span>
          <span class="s">}</span>
        <span class="s">]</span>
      <span class="s">}</span>
  <span class="na">env</span><span class="pi">:</span>
    <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>

</code></pre></div></div><p>簡単なメッセージを送る時にはこの<code class="language-plaintext highlighter-rouge">slack-github-action</code>を使うと便利に<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送ることができます。</p><h2 id="composite-action">Composite Action</h2><p>会社では<code class="language-plaintext highlighter-rouge">slack-github-action</code>を使わず、次のように<code class="language-plaintext highlighter-rouge">Composite Action</code>を使って<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送る方法を使っています。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Send</span><span class="nv"> </span><span class="s">Slack</span><span class="nv"> </span><span class="s">messages'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Send</span><span class="nv"> </span><span class="s">Slack</span><span class="nv"> </span><span class="s">messages'</span>

<span class="na">inputs</span><span class="pi">:</span>
  <span class="na">GITHUB_TOKEN</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">GitHub</span><span class="nv"> </span><span class="s">token</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">API'</span>
    <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Token</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">Slack</span><span class="nv"> </span><span class="s">bot'</span>
    <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">MESSAGES</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">(JSON)</span><span class="nv"> </span><span class="s">Multiple</span><span class="nv"> </span><span class="s">users</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">multiple</span><span class="nv"> </span><span class="s">Slack</span><span class="nv"> </span><span class="s">messages'</span>
    <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s1">'</span><span class="s">composite'</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Send Slack messages</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v7</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ inputs.GITHUB_TOKEN }}</span>
        <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">const slackToken = process.env.SLACK_TOKEN</span>
          <span class="s">const messages = JSON.parse(Buffer.from(process.env.MESSAGES, 'base64').toString('utf-8'));</span>
          <span class="s">const channelIDs = {</span>
            <span class="s">'GITHUB_USER_NAME_1': 'USER_CHANNEL_ID_1',</span>
            <span class="s">'GITHUB_USER_NAME_2': 'USER_CHANNEL_ID_2',</span>
            <span class="s">'GITHUB_USER_NAME_2': 'USER_CHANNEL_ID_2',</span>
            <span class="s">'GITHUB_USER_NAME_3': 'USER_CHANNEL_ID_3',</span>
            <span class="s">'GITHUB_USER_NAME_3': 'USER_CHANNEL_ID_3',</span>
            <span class="s">'GITHUB_USER_NAME_4': 'USER_CHANNEL_ID_4',</span>
          <span class="s">}</span>

          <span class="s">for (const message of messages) {</span>
            <span class="s">const { userName, messages: blocks } = message</span>
            <span class="s">const channel = channelIDs[userName]</span>
            <span class="s">fetch('https://slack.com/api/chat.postMessage', {</span>
              <span class="s">method: 'POST',</span>
              <span class="s">headers: {</span>
                <span class="s">'Content-Type': 'application/json',</span>
                <span class="s">'Authorization': `Bearer ${slackToken}`,</span>
              <span class="s">},</span>
              <span class="s">body: JSON.stringify({</span>
                <span class="s">channel,</span>
                <span class="s">blocks,</span>
              <span class="s">})</span>
            <span class="s">})</span>
            <span class="s">.then(response =&gt; response.json())</span>
            <span class="s">.then(data =&gt; {</span>
              <span class="s">if (!data.ok) {</span>
                <span class="s">throw new Error(`Slack API error: ${data.error}`);</span>
              <span class="s">}</span>
              <span class="s">console.log('Message sent to Slack successfully');</span>
            <span class="s">})</span>
            <span class="s">.catch(error =&gt; {</span>
              <span class="s">console.error('Error sending message to Slack:', error);</span>
            <span class="s">});</span>
          <span class="s">}</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">SLACK_TOKEN</span><span class="pi">:</span> <span class="s">${{ inputs.SLACK_BOT_TOKEN }}</span>
        <span class="na">MESSAGES</span><span class="pi">:</span> <span class="s">${{ inputs.MESSAGES }}</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Composite Action</code>を使うと<code class="language-plaintext highlighter-rouge">GitHub Actions</code>で<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送る部分を共通化して使うことができます。<code class="language-plaintext highlighter-rouge">Composite Action</code>については次のリンクを参考にしてください。</p><ul><li><a href="https://deku.posstree.com/github_actions/composite-action/" target="_blank">[GitHub Actions] Composite Actionを使ってGitHub Actionsの重複を減らす</a></li></ul><h2 id="reviewer通知">Reviewer通知</h2><p>このように作った<code class="language-plaintext highlighter-rouge">Composite Action</code>を使って<code class="language-plaintext highlighter-rouge">GitHub Actions</code>を使ってReviewerに指定された場合、<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送る方法について説明します。</p><p><code class="language-plaintext highlighter-rouge">GitHub Actions</code>でReviewerに指定された場合、<code class="language-plaintext highlighter-rouge">Slack</code>の個人チャンネルにメッセージを送るためには次のように<code class="language-plaintext highlighter-rouge">GitHub Actions</code>を作成することができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[Slack]</span><span class="nv"> </span><span class="s">Reviewer</span><span class="nv"> </span><span class="s">assigned'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">review_requested</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">notify_for_reviewer</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Slack messages</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">make-slack-messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v7</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">const prNumber = context.payload.pull_request.number;</span>
            <span class="s">const prTitle = context.payload.pull_request.title;</span>
            <span class="s">const prLink = context.payload.pull_request.html_url;</span>
            <span class="s">const { data: reviewers } = await github.rest.pulls.listRequestedReviewers({</span>
              <span class="s">owner: context.repo.owner,</span>
              <span class="s">repo: context.repo.repo,</span>
              <span class="s">pull_number: prNumber,</span>
            <span class="s">});</span>

            <span class="s">let slackMessages = []</span>
            <span class="s">const reviewerLogins = reviewers.users.map(user =&gt; user.login);</span>
            <span class="s">for (const userName of reviewerLogins) {</span>
              <span class="s">const message = `*Reviewer notification*\n\nYou are assigned to new PR.\n\n- title: ${prTitle}\n- link: ${prLink}`</span>
              <span class="s">slackMessages.push({</span>
                <span class="s">userName,</span>
                <span class="s">messages: [</span>
                  <span class="s">{</span>
                    <span class="s">type: 'section',</span>
                    <span class="s">text: {</span>
                      <span class="s">type: 'mrkdwn',</span>
                      <span class="s">text: message,</span>
                    <span class="s">}</span>
                  <span class="s">}</span>
                <span class="s">]</span>
              <span class="s">})</span>
            <span class="s">}</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Send Slack messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/send_slack_messages</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">MESSAGES</span><span class="pi">:</span> <span class="s">${{ steps.make-slack-messages.outputs.MESSAGES }}</span>

</code></pre></div></div><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><p>この<code class="language-plaintext highlighter-rouge">GitHub Actions</code>をもっと詳しく見ていきます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[Slack]</span><span class="nv"> </span><span class="s">Reviewer</span><span class="nv"> </span><span class="s">assigned'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">review_requested</span><span class="pi">]</span>
<span class="nn">...</span>

</code></pre></div></div><p>この<code class="language-plaintext highlighter-rouge">GitHub Actions</code>は<code class="language-plaintext highlighter-rouge">pull_request</code>イベントの<code class="language-plaintext highlighter-rouge">review_requested</code>を使ってPRにReviewerが指定された場合にのみ実行されます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
<span class="nn">...</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Composite Action</code>は<code class="language-plaintext highlighter-rouge">Git</code>から管理されているため、<code class="language-plaintext highlighter-rouge">actions/checkout@v4</code>を使ってリポジトリをチェックアウトする必要があります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Slack messages</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">make-slack-messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v7</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">const prNumber = context.payload.pull_request.number;</span>
            <span class="s">const prTitle = context.payload.pull_request.title;</span>
            <span class="s">const prLink = context.payload.pull_request.html_url;</span>
            <span class="s">const { data: reviewers } = await github.rest.pulls.listRequestedReviewers({</span>
              <span class="s">owner: context.repo.owner,</span>
              <span class="s">repo: context.repo.repo,</span>
              <span class="s">pull_number: prNumber,</span>
            <span class="s">});</span>

            <span class="s">let slackMessages = []</span>
            <span class="s">const reviewerLogins = reviewers.users.map(user =&gt; user.login);</span>
            <span class="s">for (const userName of reviewerLogins) {</span>
              <span class="s">const message = `*Reviewer notification*\n\nYou are assigned to new PR.\n\n- title: ${prTitle}\n- link: ${prLink}`</span>
              <span class="s">slackMessages.push({</span>
                <span class="s">userName,</span>
                <span class="s">messages: [</span>
                  <span class="s">{</span>
                    <span class="s">type: 'section',</span>
                    <span class="s">text: {</span>
                      <span class="s">type: 'mrkdwn',</span>
                      <span class="s">text: message,</span>
                    <span class="s">}</span>
                  <span class="s">}</span>
                <span class="s">]</span>
              <span class="s">})</span>
            <span class="s">}</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
<span class="s">...</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">actions/github-script@v7</code>を使ってReviewerにメッセージを送るためのメッセージを作成します。PRのタイトル、リンクを取得してReviewer用のメッセージを作成します。</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reviewer notification
You are assigned to new PR.
- title: PR title
- link: https://...
</code></pre></div></div><p>このメッセージはPRに指定されたReviewer全員にメッセージを送ることになります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
            <span class="s">const reviewerLogins = reviewers.users.map(user =&gt; user.login);</span>
            <span class="s">for (const userName of reviewerLogins) {</span>
<span class="nn">...</span>

</code></pre></div></div><p>このように作ったメッセージを<code class="language-plaintext highlighter-rouge">JSON</code>をそのまま渡すと問題が発生します。そのため、<code class="language-plaintext highlighter-rouge">Buffer</code>を使って<code class="language-plaintext highlighter-rouge">base64</code>にエンコードして<code class="language-plaintext highlighter-rouge">core.setOutput</code>を使って<code class="language-plaintext highlighter-rouge">MESSAGES</code>に保存して渡すようにしました。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
<span class="nn">...</span>

</code></pre></div></div><p>最後は、前に作った<code class="language-plaintext highlighter-rouge">Composite Action</code>を使って<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送りました。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Send Slack messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/send_slack_messages</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">MESSAGES</span><span class="pi">:</span> <span class="s">${{ steps.make-slack-messages.outputs.MESSAGES }}</span>
<span class="nn">...</span>

</code></pre></div></div><h2 id="毎朝メッセージ送信">毎朝メッセージ送信</h2><p>レビュワーがSlackメッセージを受け取った後、PRをレビューする場合もありますが、忙しくてPRをレビューできない場合もあります。このような場合、毎朝レビュワーにメッセージを送ってPRをレビューするように促すことができます。</p><p>次のように<code class="language-plaintext highlighter-rouge">GitHub Actions</code>を作成すると、平日の朝(月〜金)9時30分(日本時間)にレビュワーにメッセージを送ることができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[Slack]</span><span class="nv"> </span><span class="s">Every</span><span class="nv"> </span><span class="s">weekday</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">9:30</span><span class="nv"> </span><span class="s">AM'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">30</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">1-5'</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">notify_reviewers_every_weekday</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Slack messages</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">make-slack-messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v7</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">const userList = [</span>
              <span class="s">'GITHUB_USER_NAME_1',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_4',</span>
            <span class="s">]</span>
            <span class="s">const escapeForSlack = (text) =&gt; {</span>
              <span class="s">return text</span>
                <span class="s">.replace(/&amp;/g, '&amp;amp;')   // &amp; → &amp;amp;</span>
                <span class="s">.replace(/&lt;/g, '&amp;lt;')    // &lt; → &amp;lt;</span>
                <span class="s">.replace(/&gt;/g, '&amp;gt;')    // &gt; → &amp;gt;</span>
                <span class="s">.replace(/"/g, '&amp;quot;')  // " → &amp;quot;</span>
                <span class="s">.replace(/'/g, '&amp;#39;');  // ' → &amp;#39;</span>
            <span class="s">}</span>

            <span class="s">// Get All PRs</span>
            <span class="s">const prList = []</span>
            <span class="s">let pageIndex = 1</span>
            <span class="s">let hasMorePages = true</span>
            <span class="s">while (hasMorePages) {</span>
              <span class="s">const result = await github.rest.pulls.list({</span>
                <span class="s">owner: context.repo.owner,</span>
                <span class="s">repo: context.repo.repo,</span>
                <span class="s">state: 'open',</span>
                <span class="s">per_page: 100,</span>
                <span class="s">page: pageIndex,</span>
              <span class="s">})</span>
              <span class="s">if (result.data.length &gt; 0) {</span>
                <span class="s">prList.push(...result.data)</span>
                <span class="s">pageIndex += 1</span>
              <span class="s">} else {</span>
                <span class="s">hasMorePages = false</span>
              <span class="s">}</span>
            <span class="s">}</span>
            <span class="s">let slackMessages = []</span>
            <span class="s">for (const userName of userList) {</span>
              <span class="s">const reviewerPRList = prList.filter(pr =&gt; pr.user.login !== 'dependabot[bot]' &amp;&amp;</span>
                <span class="s">pr.requested_reviewers.some(reviewer =&gt; reviewer.login === userName)</span>
              <span class="s">);</span>
              <span class="s">if (reviewerPRList.length &gt; 0) {</span>
                <span class="s">let message = '*Reviewer notification*\n\nYou have assigned PRs. Please review when you have time.\n'</span>
                <span class="s">reviewerPRList.forEach(pr =&gt; {</span>
                  <span class="s">message += `\n- &lt;${pr.html_url}|${escapeForSlack(pr.title)}&gt;`;</span>
                <span class="s">});</span>
                <span class="s">slackMessages.push({</span>
                  <span class="s">userName,</span>
                  <span class="s">messages: [</span>
                    <span class="s">{</span>
                      <span class="s">type: 'section',</span>
                      <span class="s">text: {</span>
                        <span class="s">type: 'mrkdwn',</span>
                        <span class="s">text: message,</span>
                      <span class="s">}</span>
                    <span class="s">}</span>
                  <span class="s">]</span>
                <span class="s">})</span>
              <span class="s">}</span>
            <span class="s">}</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Send Slack messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/send_slack_messages</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">MESSAGES</span><span class="pi">:</span> <span class="s">${{ steps.make-slack-messages.outputs.MESSAGES }}</span>

</code></pre></div></div><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><p>この<code class="language-plaintext highlighter-rouge">GitHub Actions</code>をもっと詳しく見ていきます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[Slack]</span><span class="nv"> </span><span class="s">Every</span><span class="nv"> </span><span class="s">weekday</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">9:30</span><span class="nv"> </span><span class="s">AM'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">30</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">1-5'</span>
<span class="nn">...</span>

</code></pre></div></div><p>この<code class="language-plaintext highlighter-rouge">GitHub Actions</code>は<code class="language-plaintext highlighter-rouge">schedule</code>を使って平日(1-5)の朝9時30分(日本時間)に実行されます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
<span class="nn">...</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Composite Action</code>は<code class="language-plaintext highlighter-rouge">Git</code>から管理されているため、<code class="language-plaintext highlighter-rouge">actions/checkout@v4</code>を使ってリポジトリをチェックアウトする必要があります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make Slack messages</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">make-slack-messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v7</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">const userList = [</span>
              <span class="s">'GITHUB_USER_NAME_1',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_4',</span>
            <span class="s">]</span>
            <span class="s">const escapeForSlack = (text) =&gt; {</span>
              <span class="s">return text</span>
                <span class="s">.replace(/&amp;/g, '&amp;amp;')   // &amp; → &amp;amp;</span>
                <span class="s">.replace(/&lt;/g, '&amp;lt;')    // &lt; → &amp;lt;</span>
                <span class="s">.replace(/&gt;/g, '&amp;gt;')    // &gt; → &amp;gt;</span>
                <span class="s">.replace(/"/g, '&amp;quot;')  // " → &amp;quot;</span>
                <span class="s">.replace(/'/g, '&amp;#39;');  // ' → &amp;#39;</span>
            <span class="s">}</span>

            <span class="s">// Get All PRs</span>
            <span class="s">const prList = []</span>
            <span class="s">let pageIndex = 1</span>
            <span class="s">let hasMorePages = true</span>
            <span class="s">while (hasMorePages) {</span>
              <span class="s">const result = await github.rest.pulls.list({</span>
                <span class="s">owner: context.repo.owner,</span>
                <span class="s">repo: context.repo.repo,</span>
                <span class="s">state: 'open',</span>
                <span class="s">per_page: 100,</span>
                <span class="s">page: pageIndex,</span>
              <span class="s">})</span>
              <span class="s">if (result.data.length &gt; 0) {</span>
                <span class="s">prList.push(...result.data)</span>
                <span class="s">pageIndex += 1</span>
              <span class="s">} else {</span>
                <span class="s">hasMorePages = false</span>
              <span class="s">}</span>
            <span class="s">}</span>
            <span class="s">let slackMessages = []</span>
            <span class="s">for (const userName of userList) {</span>
              <span class="s">const reviewerPRList = prList.filter(pr =&gt; pr.user.login !== 'dependabot[bot]' &amp;&amp;</span>
                <span class="s">pr.requested_reviewers.some(reviewer =&gt; reviewer.login === userName)</span>
              <span class="s">);</span>
              <span class="s">if (reviewerPRList.length &gt; 0) {</span>
                <span class="s">let message = '*Reviewer notification*\n\nYou have assigned PRs. Please review when you have time.\n'</span>
                <span class="s">reviewerPRList.forEach(pr =&gt; {</span>
                  <span class="s">message += `\n- &lt;${pr.html_url}|${escapeForSlack(pr.title)}&gt;`;</span>
                <span class="s">});</span>
                <span class="s">slackMessages.push({</span>
                  <span class="s">userName,</span>
                  <span class="s">messages: [</span>
                    <span class="s">{</span>
                      <span class="s">type: 'section',</span>
                      <span class="s">text: {</span>
                        <span class="s">type: 'mrkdwn',</span>
                        <span class="s">text: message,</span>
                      <span class="s">}</span>
                    <span class="s">}</span>
                  <span class="s">]</span>
                <span class="s">})</span>
              <span class="s">}</span>
            <span class="s">}</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
<span class="s">...</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">actions/github-script@v7</code>を使ってReviewerにメッセージを送るためのメッセージを作成します。各GitHubユーザーが割り当てられたすべてのPRを取得して、レビュワーに送るメッセージを作成します。</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reviewer notification
You have assigned PRs. Please review when you have time.
- PR title1: https://...
- PR title2: https://...
- PR title3: https://...
- PR title4: https://...
</code></pre></div></div><p>このメッセージはすでに作成したGitHubユーザーのリストにある全てのユーザーにメッセージを送ることになります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
            <span class="s">const userList = [</span>
              <span class="s">'GITHUB_USER_NAME_1',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_2',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_3',</span>
              <span class="s">'GITHUB_USER_NAME_4',</span>
            <span class="s">]</span>
<span class="nn">...</span>

</code></pre></div></div><p>このように作ったメッセージを<code class="language-plaintext highlighter-rouge">JSON</code>をそのまま渡すと問題が発生します。そのため、<code class="language-plaintext highlighter-rouge">Buffer</code>を使って<code class="language-plaintext highlighter-rouge">base64</code>にエンコードして<code class="language-plaintext highlighter-rouge">core.setOutput</code>を使って<code class="language-plaintext highlighter-rouge">MESSAGES</code>に保存して渡すようにしました。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
            <span class="s">const encodedMessages = Buffer.from(JSON.stringify(slackMessages)).toString('base64');</span>
            <span class="s">core.setOutput('MESSAGES', encodedMessages);</span>
<span class="nn">...</span>

</code></pre></div></div><p>最後は、前に作った<code class="language-plaintext highlighter-rouge">Composite Action</code>を使って<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送りました。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nn">...</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Send Slack messages</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/send_slack_messages</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">GITHUB_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">SLACK_BOT_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">MESSAGES</span><span class="pi">:</span> <span class="s">${{ steps.make-slack-messages.outputs.MESSAGES }}</span>
<span class="nn">...</span>

</code></pre></div></div><h2 id="完了">完了</h2><p>これで<code class="language-plaintext highlighter-rouge">GitHub Actions</code>を使ってReviewerに指定された場合、<code class="language-plaintext highlighter-rouge">Slack</code>メッセージを送る方法と、毎朝レビュワーにPRリストを送る方法について説明しました。</p><p>レビュワーに指定されたことが認識されなくて、レビューが遅れている場合、この方法を使ってレビュワーにメッセージを送ってレビューを促してみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="github_actions"/><summary type="html"><![CDATA[GitHub Actionsを使ってReviewerに指定された場合、Slackメッセージを送信する方法と、毎朝ReviewerにPRリストをSlackメッセージで送信する方法について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[GitHub Actions] Jestの実行Actionsのパフォーマンスを改善する</title><link href="https://deku.posstree.com/github_actions/improve-test-performance/" rel="alternate" type="text/html" title="[GitHub Actions] Jestの実行Actionsのパフォーマンスを改善する"/><published>2024-10-23T00:00:00+09:00</published><updated>2025-01-11T17:20:20+09:00</updated><id>https://deku.posstree.com/github_actions/improve-test-performance-ja</id><content type="html" xml:base="https://deku.posstree.com/github_actions/improve-test-performance/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E5%95%8F%E9%A1%8C%E7%82%B9">問題点</a></li><li><a href="#%E6%80%A7%E8%83%BD%E6%94%B9%E5%96%84">性能改善</a><ul><li><a href="#dependencies-cache">Dependencies Cache</a></li><li><a href="#actions%E5%88%86%E9%9B%A2">Actions分離</a></li><li><a href="#jest%E3%81%AEbail">Jestのbail</a></li><li><a href="#jest%E3%81%AEshard%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">Jestのshardオプション</a></li></ul></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>最近、会社でテストコードが増えてきたため、<code class="language-plaintext highlighter-rouge">GitHub Actions</code>でコードをチェックするActionに時間がかかるようになりました。この問題を解決するために、<code class="language-plaintext highlighter-rouge">Jest</code>を実行するActionのパフォーマンスを改善した内容を共有したいと思います。</p><h2 id="問題点">問題点</h2><p>現在、次のようなActionを使用してPRをチェックしています。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">check-code</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Check Code</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Prettier</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn format</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn cspell</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn lint</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn stylelint</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">yarn test:ci</span>
          <span class="s">yarn test:storybook</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">yarn build</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build SCSS</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">yarn typegen:scss</span>

          <span class="s"># Get the changed files</span>
          <span class="s">CHANGED_FILES=$(git diff --name-only HEAD)</span>
          <span class="s"># Check if there are changes in the generated files</span>
          <span class="s">if [ -n "$CHANGED_FILES" ]; then</span>
            <span class="s">echo "Error: There are changes in the following files: $CHANGED_FILES"</span>
            <span class="s">exit 1</span>
          <span class="s">fi</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">PR</code>が作成されるたびに<code class="language-plaintext highlighter-rouge">Prettier</code>、<code class="language-plaintext highlighter-rouge">CSpell</code>、<code class="language-plaintext highlighter-rouge">ESLint</code>、<code class="language-plaintext highlighter-rouge">Stylelint</code>、<code class="language-plaintext highlighter-rouge">Test</code>、<code class="language-plaintext highlighter-rouge">Build</code>、<code class="language-plaintext highlighter-rouge">Build SCSS</code>が実行されています。このActionは約25分かかります。</p><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/check-code-actions.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/check-code-actions.webp" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/check-code-actions.png" alt="GitHub Actions - Improve Jest test performance"/></picture><h2 id="性能改善">性能改善</h2><p>PRを生成するたびに25分かかるのは非常に非効率的です。このブログポストでは、<code class="language-plaintext highlighter-rouge">Jest</code>を実行するActionのパフォーマンスを改善する方法について説明します。</p><h3 id="dependencies-cache">Dependencies Cache</h3><p>一番最初に行ったのは、<code class="language-plaintext highlighter-rouge">yarn install</code>でインストールされる<code class="language-plaintext highlighter-rouge">Dependencies</code>をキャッシュすることです。これにより、<code class="language-plaintext highlighter-rouge">Dependencies</code>を再インストールする時間を短縮できます。</p><p>この部分は他の<code class="language-plaintext highlighter-rouge">Actions</code>でも使用できるため、<code class="language-plaintext highlighter-rouge">Composite Action</code>として作成しました。<code class="language-plaintext highlighter-rouge">Composite Action</code>については、次のリンクを参照してください。</p><ul><li><a href="https://deku.posstree.com/github_actions/composite-action/" target="_blank">[GitHub Actions] Composite Actionを使ってGitHub Actionsの重複を減らす</a></li></ul><p>キャッシュは<code class="language-plaintext highlighter-rouge">actions/cache</code>を使って行いました。</p><ul><li><code class="language-plaintext highlighter-rouge">actions/cache</code>の公式ドキュメント: <a href="https://github.com/actions/cache" rel="nofollow noreferrer" target="_blank">https://github.com/actions/cache</a></li></ul><p><code class="language-plaintext highlighter-rouge">actions/cache</code>を使って<code class="language-plaintext highlighter-rouge">Dependencies</code>をキャッシュする<code class="language-plaintext highlighter-rouge">Composite Action</code>は次のようになります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Install</span><span class="nv"> </span><span class="s">Dependencies'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Install</span><span class="nv"> </span><span class="s">Dependencies'</span>
<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s1">'</span><span class="s">composite'</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get yarn cache directory path</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">yarn-cache-dir-path</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">echo "dir=$(yarn config get cacheFolder)" &gt;&gt; $GITHUB_OUTPUT</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v4</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">yarn-cache</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">node_modules</span>
          <span class="s">**/node_modules</span>
          <span class="s">${{ steps.yarn-cache-dir-path.outputs.dir }}</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}</span>
        <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">${{ runner.os }}-yarn-</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
      <span class="na">if</span><span class="pi">:</span> <span class="s">steps.yarn-cache.outputs.cache-hit != 'true'</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>

</code></pre></div></div><p>私たちのチームは<code class="language-plaintext highlighter-rouge">Yarn</code>の<code class="language-plaintext highlighter-rouge">3.7.0</code>バージョンを使っています。そのため、<code class="language-plaintext highlighter-rouge">corepack enable</code>を追加し、<code class="language-plaintext highlighter-rouge">Yarn 3.7.0</code>のキャッシュフォルダを取得して<code class="language-plaintext highlighter-rouge">node_modules</code>と一緒にキャッシュしました。</p><p>また、プロジェクトがモノレポであるため、<code class="language-plaintext highlighter-rouge">**/node_modules</code>を使ってサブプロジェクトの<code class="language-plaintext highlighter-rouge">node_modules</code>もキャッシュしました。</p><p>もし、皆さんのプロジェクトがモノレポではなく、<code class="language-plaintext highlighter-rouge">Yarn 3.7.0</code>も使っていない場合は、公式ドキュメントを参照して適切な設定を行ってください。</p><ul><li>公式ドキュメント: <a href="https://github.com/actions/cache?tab=readme-ov-file#implementation-examples" rel="nofollow noreferrer" target="_blank">https://github.com/actions/cache?tab=readme-ov-file#implementation-examples</a></li></ul><p>この変更により、パフォーマンスが少し向上しました。</p><ul><li>Before: 1m 25s</li></ul><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/before-cache-actions.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/before-cache-actions.webp" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/before-cache-actions.png" alt="GitHub Actions - Before using actions/cache for dependencies"/></picture><ul><li>After: 9s</li></ul><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/after-cache-actions.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/after-cache-actions.webp" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/after-cache-actions.png" alt="GitHub Actions - After using actions/cache for dependencies"/></picture><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h3 id="actions分離">Actions分離</h3><p><code class="language-plaintext highlighter-rouge">Prettier</code>、<code class="language-plaintext highlighter-rouge">CSpell</code>、<code class="language-plaintext highlighter-rouge">ESLint</code>、<code class="language-plaintext highlighter-rouge">Stylelint</code>、<code class="language-plaintext highlighter-rouge">Test</code>、<code class="language-plaintext highlighter-rouge">Build</code>、<code class="language-plaintext highlighter-rouge">Build SCSS</code>をすべて1つの<code class="language-plaintext highlighter-rouge">Action</code>で実行していました。その中で最も時間がかかったのが<code class="language-plaintext highlighter-rouge">Test</code>の実行でした。</p><p>なので、<code class="language-plaintext highlighter-rouge">Test</code>が実行される間に他の<code class="language-plaintext highlighter-rouge">Actions</code>を実行できるように<code class="language-plaintext highlighter-rouge">Actions</code>を分離しました。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">cspell</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn cspell</span>
  <span class="na">remark</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn remark:service_1</span>
  <span class="na">eslint</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn lint:service_1</span>
  <span class="na">stylelint</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn stylelint:service_1</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn build:service_1</span>
  <span class="na">test-service_1</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Test service_1</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn test:ci:service_1</span>
</code></pre></div></div><p>モノレポを使っているため、このような<code class="language-plaintext highlighter-rouge">GitHub Actions</code>はサービスごとに存在し、<code class="language-plaintext highlighter-rouge">if</code>文を使ってそのサービスだけが実行されるようにしています。</p><p>分離する前には、この<code class="language-plaintext highlighter-rouge">Action</code>は約25分かかりました。</p><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/check-code-actions.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/check-code-actions.webp" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/check-code-actions.png" alt="GitHub Actions - Before separating actions"/></picture><p>分離した後、この<code class="language-plaintext highlighter-rouge">Action</code>は約13分程度で性能が改善されました。</p><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" alt="GitHub Actions - After separating actions"/></picture><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h3 id="jestのbail">Jestのbail</h3><p><code class="language-plaintext highlighter-rouge">Jest</code>の<code class="language-plaintext highlighter-rouge">bail</code>オプションを使うと、テスト中に1つでもテストが失敗した場合にテストを中止するように設定できます。</p><p>このオプションを追加することで、テストが失敗した場合にすぐにすべてのテストを実行せずに中止することができ、時間を短縮できます。</p><p><code class="language-plaintext highlighter-rouge">Jest</code>の<code class="language-plaintext highlighter-rouge">bail</code>オプションを設定するために、<code class="language-plaintext highlighter-rouge">jest</code>を実行するコマンドが含まれる<code class="language-plaintext highlighter-rouge">package.json</code>ファイルを開いて、次のように変更します。</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
    </span><span class="nl">"test:ci"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest --ci --bail"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><h3 id="jestのshardオプション">Jestのshardオプション</h3><p><code class="language-plaintext highlighter-rouge">Jest</code>の<code class="language-plaintext highlighter-rouge">shard</code>オプションを使うと、テストを並列で実行できます。<code class="language-plaintext highlighter-rouge">shard</code>を使ってテストを並列で実行するために、<code class="language-plaintext highlighter-rouge">Jest</code>を実行する<code class="language-plaintext highlighter-rouge">Action</code>を開いて次のように変更します。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="s">...</span>
  <span class="s">test-service_1</span><span class="err">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.head_ref, 'service_1') || contains(github.head_ref, 'npm_and_yarn') || contains(github.head_ref, 'github_actions') || contains(github.head_ref, 'components') || contains(github.head_ref, 'config') || contains(github.head_ref, 'common')</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Test service_1</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">shard</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1</span><span class="pi">,</span> <span class="nv">2</span><span class="pi">,</span> <span class="nv">3</span><span class="pi">,</span> <span class="nv">4</span><span class="pi">,</span> <span class="nv">5</span><span class="pi">,</span> <span class="nv">6</span><span class="pi">,</span> <span class="nv">7</span><span class="pi">,</span> <span class="nv">8</span><span class="pi">,</span> <span class="nv">9</span><span class="pi">,</span> <span class="nv">10</span><span class="pi">]</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn test:ci:service_1 -- --shard=$/10</span>
</code></pre></div></div><p>このプロジェクトでは、モノレポを管理するために<code class="language-plaintext highlighter-rouge">Turborepo</code>を使っています。</p><ul><li><code class="language-plaintext highlighter-rouge">Turborepo</code>公式ドキュメント: <a href="https://turborepo.com/" rel="nofollow noreferrer">https://turborepo.com/</a></li></ul><p>この<code class="language-plaintext highlighter-rouge">Action</code>で実行する<code class="language-plaintext highlighter-rouge">yarn test:ci:service_1</code>は<code class="language-plaintext highlighter-rouge">turbo test:ci --parallel --filter=service_1</code>コマンドを実行します。そのため、<code class="language-plaintext highlighter-rouge">Jest</code>の<code class="language-plaintext highlighter-rouge">--shard</code>オプションを渡すために<code class="language-plaintext highlighter-rouge">--</code>を使ってオプションを渡しました。</p><p><code class="language-plaintext highlighter-rouge">shard</code>オプションを追加する前のテストは約13分かかりました。</p><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/after-separating-actions" alt="GitHub Actions - After separating action"/></picture><p><code class="language-plaintext highlighter-rouge">shard</code>オプションを追加した後、テストは約2~3分かかりました。</p><picture><source srcset="/assets/images/category/github_actions/improve-test-performance/jest-shard-option.avif" type="image/avif"/><source srcset="/assets/images/category/github_actions/improve-test-performance/jest-shard-option.webp" type="image/webp"/><img src="/assets/images/category/github_actions/improve-test-performance/jest-shard-option.png" alt="GitHub Actions - Use Jest shard option"/></picture><h2 id="完了">完了</h2><p>このブログポストでは、<code class="language-plaintext highlighter-rouge">Jest</code>を実行する<code class="language-plaintext highlighter-rouge">Action</code>のパフォーマンスを改善する方法について説明しました。パフォーマンス改善前には約25分かかりましたが、パフォーマンス改善後には約2~3分かかるようになりました。</p><p>皆さんも<code class="language-plaintext highlighter-rouge">Cache</code>、<code class="language-plaintext highlighter-rouge">Actions分離</code>、<code class="language-plaintext highlighter-rouge">shard</code>オプションを使って<code class="language-plaintext highlighter-rouge">Jest</code>を実行する<code class="language-plaintext highlighter-rouge">Action</code>のパフォーマンスを改善してみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="github_actions"/><summary type="html"><![CDATA[GitHub ActionsでJestを実行するActionのパフォーマンスを改善する方法について紹介します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[GitHub Actions] Composite Actionを使ってGitHub Actionsの重複を減らす</title><link href="https://deku.posstree.com/github_actions/composite-action/" rel="alternate" type="text/html" title="[GitHub Actions] Composite Actionを使ってGitHub Actionsの重複を減らす"/><published>2024-10-22T00:00:00+09:00</published><updated>2025-01-11T17:20:20+09:00</updated><id>https://deku.posstree.com/github_actions/composite-actions-ja</id><content type="html" xml:base="https://deku.posstree.com/github_actions/composite-action/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#composite-action%E3%81%A8%E3%81%AF">Composite Actionとは</a></li><li><a href="#%E9%87%8D%E8%A4%87%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8C%E3%81%82%E3%82%8Bgithub-action%E3%81%AE%E4%BE%8B">重複コードがあるGitHub Actionの例</a></li><li><a href="#composite-action%E3%82%92%E4%BD%9C%E3%82%8B">Composite Actionを作る</a></li><li><a href="#composite-action%E3%82%92%E4%BD%BF%E3%81%86">Composite Actionを使う</a></li><li><a href="#composite-action%E3%81%AEinputs">Composite Actionのinputs</a></li><li><a href="#composite-action%E3%81%AEoutputs">Composite Actionのoutputs</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>GitHub Actionsを使って開発をする際にActionで共通で使う部分が出てくることがあります。この時、Composite Actionを使うと共通で使う部分を一つのActionにまとめて再利用性を高めることができます。</p><p>このブログポストではComposite Actionを使ってGitHub Actionsの再利用性を高める方法について紹介します。</p><h2 id="composite-actionとは">Composite Actionとは</h2><p>Composite Actionは複数のActionを一つのActionにまとめて使うことができる機能です。Composite Actionを使うと複数のActionで共通で使う部分を一つのActionにまとめて再利用性を高めることができます。</p><ul><li>公式ドキュメント: <a href="https://docs.github.com/en/actions/sharing-automations/creating-actions/creating-a-composite-action" rel="nofollow noreferrer" target="_blank">Composite Action</a></li></ul><h2 id="重複コードがあるgithub-actionの例">重複コードがあるGitHub Actionの例</h2><p>Reactを使うプロジェクトで次のようなGitHub Actionsを使うことができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Check</span><span class="nv"> </span><span class="s">code'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">cspell</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn cspell</span>
  <span class="na">remark</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn remark</span>
  <span class="na">eslint</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn lint</span>
  <span class="na">stylelint</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn stylelint</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn test</span>
</code></pre></div></div><p>Reactプロジェクトで<code class="language-plaintext highlighter-rouge">CSpell</code>と複数の<code class="language-plaintext highlighter-rouge">Linter</code>と<code class="language-plaintext highlighter-rouge">Test</code>を実行するGitHub Actionsです。ここでDependenciesをインストールする部分が重複していることが分かります。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="s">...</span>
      <span class="s">- name</span><span class="err">:</span> <span class="s">Setup node</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/setup-node@v4</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
      <span class="s">...</span>
</code></pre></div></div><p>この部分をComposite Actionを使って一つのActionにまとめて再利用する方法について見ていきます。</p><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="composite-actionを作る">Composite Actionを作る</h2><p>Dependenciesをインストールする部分をComposite Actionにするために<code class="language-plaintext highlighter-rouge">.github/actions/install-dependencies.yml</code>ファイルを作成して次のように修正します。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Install</span><span class="nv"> </span><span class="s">Dependencies'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Install</span><span class="nv"> </span><span class="s">Dependencies'</span>

<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s1">'</span><span class="s">composite'</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup node</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v4</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">node-version</span><span class="pi">:</span> <span class="s">20.3.0</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Yarn 3.7.0</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">corepack enable</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">yarn install --frozen-lockfile</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Composite Action</code>を使うためには<code class="language-plaintext highlighter-rouge">using</code>キーワードに<code class="language-plaintext highlighter-rouge">composite</code>を使ってComposite Actionであることを明示します。そして<code class="language-plaintext highlighter-rouge">steps</code>にComposite Actionを実行するステップを記述します。</p><p>コマンドを実行する際には<code class="language-plaintext highlighter-rouge">shell</code>キーワードに<code class="language-plaintext highlighter-rouge">bash</code>を使ってbashシェルを使うように設定する必要があります。</p><h2 id="composite-actionを使う">Composite Actionを使う</h2><p>Composite Actionを使うためにはGitHub Actionsを次のように修正します。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Check</span><span class="nv"> </span><span class="s">code'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">cspell</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CSpell</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn cspell</span>
  <span class="na">remark</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Remark-lint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn remark</span>
  <span class="na">eslint</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ESLint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn lint</span>
  <span class="na">stylelint</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Stylelint</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn stylelint</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">yarn test</span>
</code></pre></div></div><p>공통으로 분리한 Composite Action을 다음과 같이 사용하도록 수정하였습니다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="s">...</span>
       <span class="s">- name</span><span class="err">:</span> <span class="s">Checkout code</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/checkout@v4</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
<span class="err">      </span><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/install_dependencies</span>
      <span class="s">...</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Composite Action</code>는 <code class="language-plaintext highlighter-rouge">.github</code>フォルダで管理しているため、<code class="language-plaintext highlighter-rouge">actions/checkout</code>を使ってコードを先にチェックアウトする必要があります。その後、<code class="language-plaintext highlighter-rouge">uses</code>キーワードにComposite Actionのパスを記述してComposite Actionを使えます。</p><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="composite-actionのinputs">Composite Actionのinputs</h2><p><code class="language-plaintext highlighter-rouge">Composite Action</code>を使う際、特定の値を渡してActionを実行したい場合があります。この場合、<code class="language-plaintext highlighter-rouge">Composite Action</code>の<code class="language-plaintext highlighter-rouge">inputs</code>を使って値を渡すことができます。</p><p><code class="language-plaintext highlighter-rouge">Composite Action</code>の<code class="language-plaintext highlighter-rouge">inputs</code>を使うため、<code class="language-plaintext highlighter-rouge">Composite Action</code>を次のように修正します。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Composite</span><span class="nv"> </span><span class="s">Action</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">inputs'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Composite</span><span class="nv"> </span><span class="s">Action</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">inputs'</span>
<span class="na">inputs</span><span class="pi">:</span>
  <span class="na">variable_name</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Description</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">variable'</span>
    <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">default</span><span class="pi">:</span> <span class="s1">'</span><span class="s">variable_default_value'</span>
<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s1">'</span><span class="s">composite'</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Print Composite Action inputs variable</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">echo ${{ inputs.variable_name }}</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>

</code></pre></div></div><p>この<code class="language-plaintext highlighter-rouge">inputs</code>を使うと条件によって異なる動作をする<code class="language-plaintext highlighter-rouge">Composite Action</code>を作成することができます。</p><p>このように作った<code class="language-plaintext highlighter-rouge">Composite Action</code>は次のように使って<code class="language-plaintext highlighter-rouge">Composite Action</code>の<code class="language-plaintext highlighter-rouge">inputs</code>を使うことができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
      <span class="s">...</span>
      <span class="s">- name</span><span class="err">:</span> <span class="s">Checkout code</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/checkout@v4</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
<span class="err">      </span><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Composite Action with inputs</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/composite_action</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">variable_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">test_input_value'</span>
      <span class="s">...</span>

</code></pre></div></div><h2 id="composite-actionのoutputs">Composite Actionのoutputs</h2><p><code class="language-plaintext highlighter-rouge">Composite Action</code>を使う際、<code class="language-plaintext highlighter-rouge">Composite Action</code>から特定の値を受け取ってActionを実行したい場合があります。この場合、<code class="language-plaintext highlighter-rouge">Composite Action</code>の<code class="language-plaintext highlighter-rouge">outputs</code>を使って値を渡すことができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Composite</span><span class="nv"> </span><span class="s">Action</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">outputs'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Composite</span><span class="nv"> </span><span class="s">Action</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">outputs'</span>
<span class="na">outputs</span><span class="pi">:</span>
  <span class="na">variable_name</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">variable</span><span class="nv"> </span><span class="s">description"</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s">${{ steps.output_step.outputs.output_variable_name }}</span>
<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s1">'</span><span class="s">composite'</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set outputs</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">output_step</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">echo "output_variable_name=test_output_value" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>

</code></pre></div></div><p>このように作った<code class="language-plaintext highlighter-rouge">Composite Action</code>は次のように使って<code class="language-plaintext highlighter-rouge">Composite Action</code>の<code class="language-plaintext highlighter-rouge">outputs</code>を使うことができます。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
      <span class="s">...</span>
      <span class="s">- name</span><span class="err">:</span> <span class="s">Checkout code</span>
        <span class="s">uses</span><span class="err">:</span> <span class="s">actions/checkout@v4</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">0</span>
<span class="err">      </span><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Composite Action with outputs</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">composite_action</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/actions/composite_action</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Print Composite Action outputs variable</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo ${{ steps.composite_action.outputs.variable_name }}</span>
      <span class="s">...</span>

</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">outputs</code>を使うと<code class="language-plaintext highlighter-rouge">Composite Action</code>の実行結果を使う<code class="language-plaintext highlighter-rouge">Action</code>を作成することができます。</p><h2 id="完了">完了</h2><p>これで<code class="language-plaintext highlighter-rouge">Composite Action</code>を使ってGitHub Actionsの重複を減らし、Actionの再利用性を高める方法について紹介しました。</p><p>皆さんももし重複するActionがあれば<code class="language-plaintext highlighter-rouge">Composite Action</code>を使ってActionの再利用性を高めてみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="github_actions"/><summary type="html"><![CDATA[GitHub Actionsで重複で使われるActionをComposite Actionで作ってActionの再利用性を高める方法について紹介します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/github_actions/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">ミス管理戦略</title><link href="https://deku.posstree.com/essay/mistakes-management/" rel="alternate" type="text/html" title="ミス管理戦略"/><published>2024-10-15T00:00:00+09:00</published><updated>2024-12-03T20:54:19+09:00</updated><id>https://deku.posstree.com/essay/mistakes-management-ja</id><content type="html" xml:base="https://deku.posstree.com/essay/mistakes-management/"><![CDATA[<p>人は誰でもミスをします。どれだけ注意して何度確認しても、ミスは発生します。私たちが専門家と呼ぶ人々も、1時間に平均3〜5回のミスをします。</p><p>会社やチームは人々で構成されており、人々が製品やサービスを作ります。そのため、製品やサービスには障害やバグが発生し、会社はこのような問題（ミス）を解決しなければなりません。</p><p>会社では、このようなミスに対処するために<code class="language-plaintext highlighter-rouge">ミス予防</code>と<code class="language-plaintext highlighter-rouge">ミス管理</code>という戦略を使うことができます。</p><ul><li>ミス予防: ミスをしないようにする戦略。ミスに至る経路を遮断し、ミスを犯さないように要求する戦略。</li><li>ミス管理: ミスをしても早く発見して早く修正する戦略。</li></ul><blockquote><p>アメリカの中西部の有名な病院で、2006年に新生児室の赤ちゃんにヘパリンを基準値の1,000倍投与する事件が発生します。1週間にわたって5人の看護師が合計6人の赤ちゃんにそのように投与をし、その赤ちゃんのうち3人が亡くなり、残りの3人も重傷を負いました。さらに驚くべきことに、その病院に2001年にヘパリン過剰投与で似たような事故があり、この事故を契機に安全プログラムを運営しており、その面で優れた病院として認められていたという点です。しかし、調査によるとこの事件は、病院の安全プロセスがあまりにも信頼できるために起こりました。新しい標準運用手順のおかげで薬剤師がヘパリンを準備する際にミスの余地がないと信じた看護師たちは、もはや薬の投与時に確認すべきことを気にしなくなりました。実際、その方法は事故が起きる前までは効果的でした。</p></blockquote><p>この例は<code class="language-plaintext highlighter-rouge">ミス予防</code>戦略を使用しましたが、この戦略をあまり信じすぎたために別のミスが発生しました。</p><p>ミスを予防するために作られた安全プロセスが完璧だと思ったため、看護師たちは薬剤師がヘパリンの準備でミスをしないだろうと信じました。この安全プロセスを信じた看護師たちは、薬の投与時に確認すべきことを気にしないミスを犯してしまい、このような問題が再発することになりました。</p><p><code class="language-plaintext highlighter-rouge">ミス予防</code>はミスをしないようにする戦略ですが、人がミスをしないようにすることは不可能です。したがって、この戦略を実行することは実際には不可能です。</p><p><code class="language-plaintext highlighter-rouge">ミス管理</code>は、ミスがいつでも発生する可能性があると認識し、その代わりミスが最悪になる前に早く発見して早く修正しようとする戦略です。</p><p><code class="language-plaintext highlighter-rouge">ミス予防</code>はミスをした人を非難し、処罰することが多いため、ミスを隠そうとする傾向が多く見られます。</p><p><code class="language-plaintext highlighter-rouge">ミス管理</code>は、ミスがより大きな問題になる前にそれを修正しようとするため、ミスを共有し、そこから学ぼうとする傾向が多く見られます。</p><p>専門家でも1時間に平均3〜5回のミスをしますが、会社が潰れずにサービスが継続される理由は、専門家がミスを早期に発見して迅速な対応を取っているからです。専門家は自分がミスをする可能性があることを認め、ミスがより悪い状況になる前に早く発見して早く修正しようと努力します。</p><p><a href="https://www.researchgate.net/publication/7453312_Organizational_Error_Management_Culture_and_Its_Impact_on_Performance_A_Two-Study_Replication" rel="nofollow noreferrer" target="_blank">Cathy van Dyck, Michael Frese, Markus Baer, &amp; Doris Sonnentag. (2005) Organizational error management culture and its impact on performance: A two-study replication. Journal of Applied Psychology</a>の研究結果を見ると、会社がミス予防よりもミス管理戦略を使用するほど、その企業の革新度が高いと言います。また、この研究では、ミス予防よりもミス管理戦略が会社の収益率を高めると言います。</p><p>人はミスを通じて多くのことを学びます。逆に言えば、ミスをしないと学習できません。したがって、ミス管理戦略ほど学習がよくなります。従業員にミスをしないように言うことは、学習をしないように指示することと同じです。さまざまなミスを経験することを奨励し、ミスの事例を学び、ミス時の対処方法を教える教育がより効果的な教育方法であるという研究結果も多いです。会社でミスを経験するように奨励する必要はありませんが、ミスをしてもそれを通じて学習できる環境を作る必要があります。</p><p>ミス管理戦略は<code class="language-plaintext highlighter-rouge">2次的ミス予防</code>に拡張できます。<code class="language-plaintext highlighter-rouge">2次的ミス予防</code>は既に発生したミスについて学習し、その後「次回はこう行動しよう」と計画を立てることです。</p><p>ミス管理戦略を取るためには、ミスが発生することは早く検知する<code class="language-plaintext highlighter-rouge">モニタリング</code>が必要です。そしてこれを早く<code class="language-plaintext highlighter-rouge">対応</code>しなければなりません。対応後にはこのミスについて<code class="language-plaintext highlighter-rouge">学習</code>をし、同じミスが繰り返されないように<code class="language-plaintext highlighter-rouge">予防</code>措置を取らなければなりません。</p><ul><li>モニタリング &gt; 対応する &gt; 学習する &gt; 予防する</li></ul><p>まとめると、人は誰でもミスをします。専門家でも1時間に3〜5回のミスをします。人々はミスを通じて学習します。ミス予防よりもミスを管理する戦略が企業の革新度を高め、会社の収益率も高めます。したがって、ミスを予防することは不可能だということを認め、ミスを管理できる努力をしなければなりません。代表的なミス管理方法は、ミスが発生するかどうかをモニタリングし、発生時に迅速に対応し、これを通じて学習した後、同じミスが繰り返されないように予防措置を取ることです。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="essay"/><summary type="html"><![CDATA[組織でミスを管理する方法と、ミスに対する戦略がチームに与える影響について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/essay/2024/mistakes-management/background.jpg"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/essay/2024/mistakes-management/background.jpg" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[Flutter] PageViewウィジェットの使い方</title><link href="https://deku.posstree.com/flutter/widgets/page_view/" rel="alternate" type="text/html" title="[Flutter] PageViewウィジェットの使い方"/><published>2024-10-11T00:00:00+09:00</published><updated>2025-01-03T17:30:19+09:00</updated><id>https://deku.posstree.com/flutter/widgets/widget-page-view-ja</id><content type="html" xml:base="https://deku.posstree.com/flutter/widgets/page_view/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#pageview%E3%82%A6%E3%82%A3%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88">PageViewウィジェット</a></li><li><a href="#pageview%E3%82%A6%E3%82%A3%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9">PageViewウィジェットの使い方</a></li><li><a href="#pagecontroller">PageController</a></li><li><a href="#scrolldirection%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">scrollDirectionオプション</a></li><li><a href="#onpagechanged%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">onPageChangedオプション</a></li><li><a href="#pageview-builder">PageView Builder</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>Flutterでアプリを開発する時、<code class="language-plaintext highlighter-rouge">TikTok</code>のように画面全体をスクロールする機能を実装したい時があります。この時Flutterが基本的に提供する<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを使えば簡単に実装できます。</p><p>このブログポストでは、<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを使う方法について説明します。</p><p>このブログポストで紹介するソースコードは以下のリンクで確認できます。</p><ul><li>GitHub: <a href="https://github.com/dev-yakuza/study-flutter/tree/main/widget/page_view" rel="nofollow noreferrer" target="_blank">https://github.com/dev-yakuza/study-flutter/tree/main/widget/page_view</a></li></ul><h2 id="pageviewウィジェット">PageViewウィジェット</h2><p>Flutterが提供する<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットはスクロールを通じて画面全体を移動するウィジェットです。<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットは<code class="language-plaintext highlighter-rouge">children</code>プロパティを通じて複数のウィジェットを渡してページを構成できます。</p><picture><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" type="image/avif"/><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" type="image/webp"/><img src="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" alt="Flutter - PageView widget scroll vertical"/></picture><p>公式ドキュメントを通じて<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットについて詳しい情報を確認できます。</p><ul><li>公式ドキュメント: <a href="https://api.flutter.dev/flutter/widgets/PageView-class.html" rel="nofollow noreferrer" target="_blank">PageView class</a></li></ul><h2 id="pageviewウィジェットの使い方">PageViewウィジェットの使い方</h2><p><code class="language-plaintext highlighter-rouge">PageView</code>はFlutterが基本的に提供するウィジェットなので、次のように<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを簡単に使うことができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyHomePage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="n">MyHomePage</span><span class="p">({</span><span class="k">super</span><span class="o">.</span><span class="na">key</span><span class="p">});</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">body:</span> <span class="n">PageView</span><span class="p">(</span>
        <span class="nl">children:</span> <span class="p">[</span>
          <span class="n">Container</span><span class="p">(</span>
            <span class="nl">width:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">height:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span><span class="p">,</span>
          <span class="p">),</span>
          <span class="n">Container</span><span class="p">(</span>
            <span class="nl">width:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">height:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">blue</span><span class="p">,</span>
          <span class="p">),</span>
          <span class="n">Container</span><span class="p">(</span>
            <span class="nl">width:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">height:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
            <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">green</span><span class="p">,</span>
          <span class="p">),</span>
        <span class="p">],</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットの<code class="language-plaintext highlighter-rouge">children</code>に表示するウィジェットを一緒に渡すと、次のように画面全体をスクロールしてページを移動できるようになります。</p><picture><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_horizontal.gif" type="image/avif"/><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_horizontal.gif" type="image/webp"/><img src="/assets/images/category/flutter/2024/page_view/page_view_scroll_horizontal.gif" alt="Flutter - PageView widget scroll horizontal"/></picture><p>ここでは分かりやすくするために<code class="language-plaintext highlighter-rouge">Container</code>ウィジェットを使用しました。</p><h2 id="pagecontroller">PageController</h2><p><code class="language-plaintext highlighter-rouge">PageController</code>を使用すると初期に表示するページを決定できます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyHomePage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">pageController</span> <span class="o">=</span> <span class="n">PageController</span><span class="p">(</span>
    <span class="nl">initialPage:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="n">MyHomePage</span><span class="p">({</span><span class="k">super</span><span class="o">.</span><span class="na">key</span><span class="p">});</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
      <span class="nl">body:</span> <span class="n">PageView</span><span class="p">(</span>
        <span class="nl">controller:</span> <span class="n">pageController</span><span class="p">,</span>
        <span class="nl">children:</span> <span class="p">[</span>
          <span class="p">...</span>
        <span class="p">],</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">PageController</code>の<code class="language-plaintext highlighter-rouge">initialPage</code>プロパティに初めに表示するページのインデックスを設定できます。このように変更してアプリを再実行すると、初めに表示されるページが変更されたことを確認できます。</p><div class="in-feed-ads ads-container"><div class="ads-block ads-left"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="2718813593"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><div class="ads-block ads-center"><ins class="adsbygoogle" style="display: block; text-align: center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7987914246691031" data-ad-slot="6492035359"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><h2 id="scrolldirectionオプション">scrollDirectionオプション</h2><p><code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットは<code class="language-plaintext highlighter-rouge">scrollDirection</code>オプションを通じてスクロール方向を設定できます。基本的に<code class="language-plaintext highlighter-rouge">scrollDirection</code>オプションは<code class="language-plaintext highlighter-rouge">Axis.horizontal</code>に設定されていますが、これを<code class="language-plaintext highlighter-rouge">Axis.vertical</code>に設定して垂直方向にスクロールできます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PageView</span><span class="p">(</span>
  <span class="nl">controller:</span> <span class="n">pageController</span><span class="p">,</span>
  <span class="nl">scrollDirection:</span> <span class="n">Axis</span><span class="o">.</span><span class="na">vertical</span><span class="p">,</span>
  <span class="nl">children:</span> <span class="p">[</span>
    <span class="p">...</span>
  <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div><p>このように修正して実行すると、次のように垂直方向にスクロールできるページを確認できます。</p><picture><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" type="image/avif"/><source srcset="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" type="image/webp"/><img src="/assets/images/category/flutter/2024/page_view/page_view_scroll_vertical.gif" alt="Flutter - PageView widget scroll vertical"/></picture><h2 id="onpagechangedオプション">onPageChangedオプション</h2><p><code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットは<code class="language-plaintext highlighter-rouge">onPageChanged</code>オプションを通じてページが変更された時に呼び出されるコールバック関数を設定できます。これを通じてページが変更された時に追加的な作業を行うことができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PageView</span><span class="p">(</span>
  <span class="nl">controller:</span> <span class="n">pageController</span><span class="p">,</span>
  <span class="nl">onPageChanged:</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">'Page changed to </span><span class="si">$index</span><span class="s">'</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nl">children:</span> <span class="p">[</span>
    <span class="p">...</span>
  <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div><h2 id="pageview-builder">PageView Builder</h2><p><code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットは<code class="language-plaintext highlighter-rouge">PageView.builder</code>コンストラクタを通じて動的にページを作成することができます。<code class="language-plaintext highlighter-rouge">PageView.builder</code>コンストラクタは<code class="language-plaintext highlighter-rouge">itemBuilder</code>プロパティを通じてページを作成する関数を渡すことができます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PageView</span><span class="o">.</span><span class="na">builder</span><span class="p">(</span>
  <span class="nl">controller:</span> <span class="n">pageController</span><span class="p">,</span>
  <span class="nl">itemCount:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nl">itemBuilder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Container</span><span class="p">(</span>
      <span class="nl">width:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
      <span class="nl">height:</span> <span class="kt">double</span><span class="o">.</span><span class="na">infinity</span><span class="p">,</span>
      <span class="nl">color:</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">Colors</span><span class="o">.</span><span class="na">red</span> <span class="o">:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">blue</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div><h2 id="完了">完了</h2><p>今回のブログポストではFlutterが基本的に提供する<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを使ってページ全体をスクロールする方法について説明しました。<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを使うと簡単にページ全体をスクロールでき、<code class="language-plaintext highlighter-rouge">scrollDirection</code>オプションを通じてスクロール方向を設定できます。</p><p><code class="language-plaintext highlighter-rouge">PageView</code>を使うと、<code class="language-plaintext highlighter-rouge">TikTok</code>のように画面全体をスクロールする機能を簡単に実装できます。もし、実装中のアプリが画面全体をスクロールする機能が必要なら、<code class="language-plaintext highlighter-rouge">PageView</code>ウィジェットを使って実装してみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="flutter"/><summary type="html"><![CDATA[Flutterが基本的提供するPageViewウィジェットを使ってページ全体をスクロールする方法について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/flutter/background.png"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/flutter/background.png" xmlns:media="http://search.yahoo.com/mrss/"/></entry><entry xml:lang="ja"><title type="html">[Flutter] Test Matcherを使う</title><link href="https://deku.posstree.com/flutter/test/matcher/" rel="alternate" type="text/html" title="[Flutter] Test Matcherを使う"/><published>2024-10-06T00:00:00+09:00</published><updated>2024-10-09T09:48:41+09:00</updated><id>https://deku.posstree.com/flutter/test/test-matcher-ja</id><content type="html" xml:base="https://deku.posstree.com/flutter/test/matcher/"><![CDATA[<div id="contents_list"><h2 id="section">目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#matcher">Matcher</a></li><li><a href="#%E3%82%88%E3%81%8F%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8Bmatcher">よく使われるMatcher</a></li><li><a href="#%E5%AE%8C%E4%BA%86">完了</a></li></ul></div><h2 id="概要">概要</h2><p>Flutterでテストコードを書く際、様々な<code class="language-plaintext highlighter-rouge">Matcher</code>を使うことができます。今回のブログポストでは、Flutterのテストコードで使える<code class="language-plaintext highlighter-rouge">Matcher</code>について紹介し、使い方について説明します。</p><h2 id="matcher">Matcher</h2><p>テストコードでMatcherは、特定の値や条件を検証するための検証ツールです。テストが実際の値と期待する値や状態が一致するかどうかを比較する際、Matcherを使ってより表現力豊かで読みやすいテストコードを書くことができます。</p><p>FlutterのテストコードでMatcherは、<code class="language-plaintext highlighter-rouge">expect</code>文を通じて値が期待する条件に一致するかを確認する際に主に使用されます。Matcherは単純な値の比較だけでなく、より複雑な条件やさまざまなタイプの検証をサポートします。</p><p>例えば:</p><ul><li>equals: 値が特定の値と同じかどうか比較できます。</li><li>isNull: 値がnullかどうかを確認できます。</li><li>contains: コレクションや文字列に特定の項目が含まれているかを検査できます。</li><li>throwsException: 関数が例外をスローするかを確認できます。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test</span><span class="p">(</span><span class="s">'Example'</span><span class="p">,</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">contains</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">isNotEmpty</span><span class="p">);</span>
    <span class="n">expect</span><span class="p">(()</span> <span class="o">=</span><span class="p">&gt;</span> <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">'Error'</span><span class="p">),</span> <span class="n">throwsException</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><p>Matcherを使うと、テストコードがより直感的で読みやすくなり、可読性が向上し、複雑な条件や状態を簡潔に処理できます。また、複数の条件を組み合わせたり否定(Negation)することができ、より柔軟なテスト作成が可能です。</p><h2 id="よく使われるmatcher">よく使われるMatcher</h2><p>Flutterの公式ドキュメントを確認すると、使用可能なMatcherを確認できます。.</p><ul><li>公式ドキュメント: <a href="https://pub.dev/documentation/matcher/latest/matcher/matcher-library.html" rel="nofollow noreferrer" target="_blank">https://pub.dev/documentation/matcher/latest/matcher/matcher-library.html</a></li></ul><p>ここでは、よく使われるMatcherを紹介します。</p><ul><li>equals(expected): 与えられた値がexpectedと同じかどうかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">));</span>
</code></pre></div></div><ul><li>isNot(matcher): 値が与えられたMatcherと一致しないかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">isNot</span><span class="p">(</span><span class="n">equals</span><span class="p">(</span><span class="mi">5</span><span class="p">)));</span>
</code></pre></div></div><ul><li>isTrue / isFalse: 値がtrueまたはfalseかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">isTrue</span><span class="p">);</span>
</code></pre></div></div><ul><li>contains(element): コレクションや文字列に特定の要素が含まれているかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">contains</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div><ul><li>isNull / isNotNull: 値がnullかどうかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">isNull</span><span class="p">);</span>
<span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">isNotNull</span><span class="p">);</span>
</code></pre></div></div><ul><li>greaterThan(value) / lessThan(value): 値が与えられた値より大きいか小さいかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">greaterThan</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</code></pre></div></div><ul><li>startsWith(prefix) / endsWith(suffix): 文字列が特定の文字列で始まるか終わるかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="s">'Flutter'</span><span class="p">,</span> <span class="n">startsWith</span><span class="p">(</span><span class="s">'Fl'</span><span class="p">));</span>
</code></pre></div></div><ul><li>throwsException / throwsA(matcher): 特定の例外が発生するかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(()</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">someFunction</span><span class="p">(),</span> <span class="n">throwsException</span><span class="p">);</span>
</code></pre></div></div><ul><li>allOf(matcher1, matcher2, …): 与えられたMatcherがすべて一致するかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allOf</span><span class="p">(</span><span class="n">startsWith</span><span class="p">(</span><span class="s">'Fl'</span><span class="p">),</span> <span class="n">contains</span><span class="p">(</span><span class="s">'utt'</span><span class="p">)));</span>
</code></pre></div></div><ul><li>anyOf(matcher1, matcher2, …): 与えられたMatcherのいずれかが一致するかを確認します。</li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">anyOf</span><span class="p">(</span><span class="n">equals</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">equals</span><span class="p">(</span><span class="mi">2</span><span class="p">)));</span>
</code></pre></div></div><ul><li>isA<T>(): 値が特定の型であるかを確認します。</T></li></ul><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">isA</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;());</span>
</code></pre></div></div><h2 id="完了">完了</h2><p>これで、Flutterのテストコードで使用可能なMatcherについて紹介しました。Matcherを使用すると、テストコードをより直感的で読みやすく書くことができ、さまざまな条件や状態を検証できます。</p><p>Flutterのウィジェットテストで、私は下記のようなコードをよく使っていました。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">titleContainer</span><span class="o">.</span><span class="na">child</span><span class="o">.</span><span class="na">runtimeType</span><span class="p">,</span> <span class="n">Container</span><span class="p">);</span>
</code></pre></div></div><p>しかし、上記のコードは<code class="language-plaintext highlighter-rouge">isA&lt;T&gt;()</code> Matcherを使用すると次のようにより明確に表現できます。</p><div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">titleContainer</span><span class="o">.</span><span class="na">child</span><span class="p">,</span> <span class="n">isA</span><span class="p">&lt;</span><span class="n">Container</span><span class="p">&gt;());</span>
</code></pre></div></div><p>皆さんもMatcherを使用してテストコードをより効果的で読みやすく書いてみてください。</p>]]></content><author><name>dev.yakuza@gmail.com</name></author><category term="flutter"/><summary type="html"><![CDATA[Flutterのテストコードで使えるMatcherについて紹介し、使い方について説明します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://deku.posstree.com/assets/images/category/flutter/background.png"/><media:content medium="image" url="https://deku.posstree.com/assets/images/category/flutter/background.png" xmlns:media="http://search.yahoo.com/mrss/"/></entry></feed>